let e={ui:new Map,cache(e,t){let F=t.indexOf(".");if(F>=0){let a=t.slice(F),l=this.ui.get(a);l||(l=new Map,this.ui.set(a,l)),l.set(t.slice(0,F),e)}else this.ui.set(t,e)},getElementByLSID:(e,t=document.body)=>t.querySelector(`[data-ls-id="${e}"]`)};for(let t of document.body.querySelectorAll("[data-ls-id]"))e.cache(t,t.dataset.lsId);e.cache(document.getElementById("svg"),"svg");let t=new Map,F={publish(e,...F){let a=t.get(e);a&&a.forEach(e=>e(...F))},subscribe(e,F){let a=t.get(e);a||(a=[],t.set(e,a)),a.push(F)},unsubscribe(e,F){let a=t.get(e);if(a){let l=a.indexOf(F);l>=0&&(a.splice(l,1),a.length||t.delete(e))}}};var a={Plants:{"bush 1":{axiom:"F",rules:{F:"F[+FF][-FF]F[-F][+F]F"},alpha:90,theta:35,iterCount:4,step:6},"bush 2":{axiom:"F",rules:{F:"FF+[+F-F-F]-[-F+F+F]"},alpha:90,theta:22.5,iterCount:4,step:9},sticks:{axiom:"X",rules:{F:"FF",X:"F[+X]F[-X]+X"},alpha:90,theta:20,iterCount:7,step:2},"plant 1":{axiom:"X",rules:{F:"FF",X:"F-[[X]+X]+F[+FX]-X"},alpha:90,theta:25,iterCount:6,step:3},"plant 2":{axiom:"F",rules:{F:"F[+F]F[-F][F]"},alpha:90,theta:20,iterCount:5,step:8},"plant 3":{axiom:"X",rules:{F:"FF",X:"F[+X][-X]FX"},alpha:90,theta:25.71,iterCount:6,step:3.5},"savine 1":{axiom:"F-F[-F+F-F]+[+F-F-F]",rules:{F:"-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:3,step:3},"savine 2":{axiom:"-[F-F[-F+F-F]+[+F-F-F]]+[F-F[-F+F-F]+[+F-F-F]]",rules:{F:"-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:3,step:3},"liana sarment":{axiom:"FYX",rules:{F:"FFFXYFXY-[FFFXYFXY]",X:"Y[[XY]+X]+F[+FX]+XF",Y:"[FFF[[YX]+Y]+F[+FY]+F]"},alpha:90,theta:20,iterCount:4,step:.5},"liana tangle":{axiom:"FYX",rules:{F:"FFFXYFXY-[FFFXYFXY]",X:"Y[[XY]+X]+F[+FX]+XF",Y:"FFF[[YX]+Y]+F[+FY]+F"},alpha:90,theta:20,iterCount:4,step:2},tree:{axiom:"F",rules:{F:"-F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:5,step:15},weed:{axiom:"F",rules:{F:"F[+F]F[-F]F"},alpha:90,theta:25.714,iterCount:5,step:2},"flower 1":{axiom:"F[+F+F][-F-F][++F][--F]F",rules:{F:"FF[++F][+F][F][-F][--F]"},alpha:90,theta:11.25,iterCount:3,step:15},"bush 3":{axiom:"VZFFF",rules:{F:"F",V:"[+++W][---W]YV",W:"+X[-W]Z",X:"-W[+X]Z",Y:"YZ",Z:"[-FFF][+FFF]F"},alpha:90,theta:20,iterCount:9,step:10},algae:{axiom:"AF",rules:{A:"FFFFFV[+++H][---Q]BW",B:"B",C:"FFFFFV[+++BA]BD",D:"FFFFFV[+++H][---Q]BE",E:"FFFFFV[+++H][---Q]BG",F:"F",G:"FFFFFV[---BA]BA",H:"IBFF",I:"BFFF[--M]J",J:"BFFF[--N]K",K:"BFFF[--O]L",L:"BFFF[--P]",M:"BFN",N:"BFO",O:"BFP",P:"BF",Q:"RBF",R:"BFFF[++M]S",S:"BFFF[++N]T",T:"BFFF[++O]U",U:"BFFF[++P]",V:"FV",W:"FFFFFV[+++H][---Q]BC"},alpha:90,theta:12,iterCount:17,step:2},"algae 2":{axiom:"AF",rules:{A:"FFFFFY[++++N][----T]BZ",B:"B",C:"FFFFFY[++++N][----T]BD",D:"FFFFFY[++++N][----T]BE",E:"FFFFFY[++++N][----T]BG",F:"F",G:"FFFFFY[+++BA]BH",H:"FFFFFY[++++N][----T]BI",I:"+FFFFFY[++++N][----T]BJ",J:"FFFFFY[++++N][----T]BK",K:"-FFFFFY[++++N][----T]BL",L:"FFFFFY[++++N][----T]BM",M:"FFFFFY[---BA]BA",N:"OBFFF",O:"BFFFP",P:"BFFF[-S]Q",Q:"BFFF[-S]R",R:"BFFF[-S]",S:"BFBF",T:"UBFFF",U:"BFFFV",V:"BFFF[+S]W",W:"BFFF[+S]X",X:"BFFF[+S]",Y:"FY",Z:"+FFFFFY[++++N][----T]BC"},alpha:90,theta:12,iterCount:17,step:2},"plant 4":{axiom:"--------C",rules:{F:"F",C:"NF[--P]F+C",N:"NFF",P:"Q",Q:"C"},alpha:0,theta:11.25,iterCount:20,step:1.2},"plant 5":{axiom:"----G",rules:{F:"F",G:"GFX[+G][-G]",X:"X[-FFF][+FFF]FX"},alpha:0,theta:25.7,iterCount:6,step:4},dandelion:{axiom:"FF[-Y][Z][+Z]",rules:{F:"F",Y:"FF+F-F-F[FFFZ][+Z]-F-FZ",Z:"FF-F+F+F[Y][-Y]+F+FY"},alpha:90,theta:15,iterCount:6,step:6},sapling:{axiom:"FFFFFFX",rules:{F:"F",X:"FFF-[-F+F[Y]-[X]]+[+F+F[X]-[X]]",Y:"FF-[-F+F]+[+F+FY]"},alpha:90,theta:15,iterCount:6,step:10},"flower 2":{axiom:"F-F+F[++X][F+X][F-X][--X]",rules:{F:"F",W:"F-F+F[++X][F+X][F-X][--X]",X:"F+FF-F[++Y][+Y][-Z][--Z]",Y:"-[Z]F-FF-FF-FF-F[Z]",Z:"+[Y]F+FF+FF+FF+F[Y]"},alpha:90,theta:10,iterCount:9,step:4.5},"bonsai branch":{axiom:"A",rules:{F:"F",A:"F-FFA+[FAFA+FFF]F"},alpha:90,theta:30,iterCount:5,step:7}},Curves:{"Hilbert curve":{axiom:"X",rules:{F:"F",X:"-YF+XFX+FY-",Y:"+XF-YFY-FX+"},alpha:0,theta:90,iterCount:6,step:7},"Gosper curve":{axiom:"XF",rules:{F:"F",X:"X+YF++YF-FX--FXFX-YF+",Y:"-FX+YFYF++YF+FX--FX-Y"},alpha:0,theta:60,iterCount:4,step:8},"Peano curve":{axiom:"F",rules:{F:"F-F+F+F+F-F-F-F+F"},alpha:45,theta:90,iterCount:4,step:8},"Sierpinski curve":{axiom:"F+FX+F+XF",rules:{F:"F",X:"XF-F+F-XF+F+XF-F+F-X"},alpha:45,theta:90,iterCount:4,step:8},curve:{axiom:"F-F-F-F-",rules:{F:"FF-F-F-F-F-F+F"},alpha:0,theta:90,iterCount:4,step:3.5},cross:{axiom:"FX",rules:{X:"FX+FX+FXFY-FY-",Y:"+FX+FXFY-FY-FY"},alpha:0,theta:90,iterCount:5,step:4.5},island:{axiom:"F+F+F+F",rules:{F:"F+F-F-FFF+F+F-F"},alpha:0,theta:90,iterCount:3,step:4},"Koch’s snowflake":{axiom:"F++F++F",rules:{F:"F-F++F-F"},alpha:0,theta:60,iterCount:4,step:5},"Koch’s curve":{axiom:"F+F+F+F",rules:{F:"FF+F+F+F+F+F-F"},alpha:0,theta:90,iterCount:4,step:3.5},chain:{axiom:"F+F+F+F",rules:{F:"F+B-F-FFF+F+B-F",B:"BBB"},alpha:0,theta:90,iterCount:3,step:4},frame:{axiom:"YXY-YXY-YXY-YXY",rules:{X:"FX+FX+FXFYFX+FXFY-FY-FY-",Y:"+FX+FX+FXFY-FYFXFY-FY-FY"},alpha:0,theta:90,iterCount:3,step:4},"Moore’s curl":{axiom:"X",rules:{X:"FX+FX+FXFYFX+FXFY-FY-FY-",Y:"+FX+FX+FXFY-FYFXFY-FY-FY"},alpha:180,theta:90,iterCount:4,step:3.5},"anklets of Krishna":{axiom:"-X--X",rules:{F:"F",X:"XFX--XFX"},alpha:0,theta:45,iterCount:5,step:10},"mango-tree foliage":{axiom:"A---A",rules:{F:"F",B:"B",A:"B-F+Z+F-BA",Z:"F-FF-F--[--Z]F-FF-F--F-FF-F--"},alpha:0,theta:60,iterCount:7,step:15},pentive:{axiom:"Q",rules:{P:"--FR++++FS--FU",Q:"FT++FR----FS++",R:"++FP----FQ++FT",S:"FU--FP++++FQ--",T:"+FU--FP+",U:"-FQ++FT-"},alpha:36,theta:36,iterCount:7,step:15},"Sierpinski median curve":{axiom:"L--F--L--F",rules:{F:"F",L:"+R-F-R+",R:"-L+F+L-"},alpha:0,theta:45,iterCount:10,step:5},lace:{axiom:"W",rules:{F:"F",W:"+++X--F--ZFX+",X:"---W++F++YFW-",Y:"+ZFX--F--Z+++",Z:"-YFW++F++Y---"},alpha:180,theta:30,iterCount:7,step:4.5},"Peano-c":{axiom:"+Z",rules:{X:"FX-FY-FX+FY+FX+FY+FX+FY+FX-FY-FX-FY-FX-FY-FX+FY+FX",Y:"FY",Z:"FX"},alpha:0,theta:45,iterCount:5,step:3.5},"Hex-7-b":{axiom:"FX",rules:{X:"-F++F-X-F--F+Y---F--F+Y+F++F-X+++F++F-X-F++F-X+++F--F+Y--",Y:"+F++F-X-F--F+Y+F--F+Y---F--F+Y---F++F-X+++F++F-X+++F--F+Y"},alpha:0,theta:30,iterCount:4,step:5}},Shapes:{"Sierpinski carpet":{axiom:"FXF--FF--FF",rules:{F:"FF",X:"--FXF++FXF++FXF--",Y:"-FX-Y"},alpha:0,theta:60,iterCount:5,step:7},mosaic:{axiom:"F-F-F-F",rules:{F:"F-B+FF-F-FF-FB-FF+B-FF+F+FF+FB+FFF",B:"BBBBBB"},alpha:0,theta:90,iterCount:2,step:7},snowflake:{axiom:"[F]+[F]+[F]+[F]+[F]+[F]",rules:{F:"F[++F][-FF]FF[+F][-F]FF"},alpha:0,theta:60,iterCount:3,step:2},crystal:{axiom:"F+F+F+F",rules:{F:"FF+F++F+F"},alpha:0,theta:90,iterCount:4,step:5},pentigree:{axiom:"F-F-F-F-F",rules:{F:"F-F++F+F-F-F"},alpha:0,theta:72,iterCount:4,step:5},square:{axiom:"F+F+F+F",rules:{F:"FF+F+F+F+FF"},alpha:0,theta:90,iterCount:4,step:5},"fluffy globule":{axiom:"X-X-X-X-X-X-X-X-X",rules:{X:"FX+X--X+X--X+X--X+X"},alpha:0,theta:40,iterCount:4,step:18},horizons:{axiom:"+F++++F",rules:{F:"F+F+F++++F+F+F"},alpha:0,theta:45,iterCount:5,step:1.3},napkin:{axiom:"F--F--F--F--F--F",rules:{F:"-F[--F--F]++F--F+"},alpha:0,theta:30,iterCount:4,step:4.5},"Levi’s fractal":{axiom:"F",rules:{F:"+F--F+"},alpha:180,theta:45,iterCount:14,step:1.9},"Levi’s carpet":{axiom:"F++F++F++F",rules:{F:"+F--F+"},alpha:180,theta:45,iterCount:14,step:1.8},"spiral tiling":{axiom:"AAAA",rules:{F:"F",A:"X+X+X+X+X+X+",X:"[F+F+F+F[---X-Y]+++++F++++++++F-F-F-F]",Y:"[F+F+F+F[---Y]+++++F++++++++F-F-F-F]"},alpha:0,theta:15,iterCount:5,step:10},"Penrose mosaic":{axiom:"+WF--XF---YF--ZF",rules:{W:"YF++ZF----XF[-YF----WF]++",X:"+YF--ZF[---WF--XF]+",Y:"-WF++XF[+++YF++ZF]-",Z:"--YF++++WF[+ZF++++XF]--XF"},alpha:270,theta:36,iterCount:6,step:11},"Penrose tesselation":{axiom:"[X]++[X]++[X]++[X]++[X]",rules:{W:"YF++ZF----XF[-YF----WF]++",X:"+YF--ZF[---WF--XF]+",Y:"-WF++XF[+++YF++ZF]-",Z:"--YF++++WF[+ZF++++XF]--XF"},alpha:0,theta:36,iterCount:5,step:20},"snowflake 2":{axiom:"F[X]F++F[X]F++F[X]F++F[X]F",rules:{X:"[+Y][-Y][++Y][--Y]",Y:"YF[X]YF"},alpha:0,theta:45,iterCount:9,step:1},wheel:{axiom:"WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW",rules:{W:"F[X]+",X:"[+++++++++++++Y[X]]-------------Y[X]",Y:"YFYF"},alpha:0,theta:5,iterCount:8,step:2},"hexagonal star":{axiom:"S",rules:{L:"LZFR--FR-F++LF++L-F+LF+R--Y",R:"Z++L-FR-F+R--FR--F+LF++LFYR",S:"L",Y:"+",Z:"-"},alpha:0,theta:60,iterCount:6,step:4.75},HexGasket:{axiom:"F+F+F+F+F+F--",rules:{F:"F+F+F--F--F+F+F"},alpha:0,theta:60,iterCount:4,step:3}},Dragons:{dragon:{axiom:"FX",rules:{F:"F",X:"X+YF+",Y:"-FX-Y"},alpha:0,theta:90,iterCount:12,step:5},terdragon:{axiom:"F",rules:{F:"F+F-F"},alpha:120,theta:120,iterCount:8,step:6},"median dragon":{axiom:"-X",rules:{F:"F",X:"X+F+Y",Y:"X-F-Y"},alpha:0,theta:45,iterCount:12,step:3}},Miscellaneous:{urchin:{axiom:"F",rules:{F:"F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:5,step:15},"Cesaro 1":{axiom:"F",rules:{F:"F++++++++++F--------------------F++++++++++F"},alpha:180,theta:8,iterCount:6,step:2.9},"Cesaro 2":{axiom:"AAAA",rules:{A:"F+++++++++F------------------",F:"F++++++++F----------------F++++++++F"},alpha:0,theta:10,iterCount:6,step:4}}};let l=/^[A-Z+\-[\]]*$/,r={messages:{AXIOM:"The axiom may contain only the following characters: “A”-Z”, “+”, “-”, “[”, “]”",RULE:"Production rules may may contain only the following characters: “A”-Z”, “+”, “-”, “[”, “]”",LETTER:"The allowed alphabet letters are: “A”-“Z”",ALPHA:"The “alpha” parameter must be a finite number",THETA:"The “theta” parameter must be a finite number",STEP:"The “step” parameter must be a positive finite number",COUNT:"The number of iterations must be integer and finite",NUMBER:"A valid finite number expected"},checkRule:(e,t=r.messages.RULE)=>l.test(e)||t,checkLetter:(e,t=r.messages.LETTER)=>1===e.length&&e>="A"&&e<="Z"||t,checkStep:(e,t=r.messages.STEP)=>Number.isFinite(e)&&e>0||t,checkCount:(e,t=r.messages.COUNT)=>Number.isInteger(e)&&e>0||t,checkNumber:(e,t=r.messages.NUMBER)=>Number.isFinite(e)||t};const s=[["F",""],["B",""],["+","+"],["-","-"],["[","["],["]","]"]],i={alpha:0,theta:0,step:10,iterCount:3};let n,o,u,h={get axiom(){return n},set axiom(e){let t=r.checkRule(e,r.messages.AXIOM);if(!0!==t)throw new Error(t);n=e},get alpha(){return u.alpha},set alpha(e){let t=r.checkNumber(e,r.messages.ALPHA);if(!0!==t)throw new Error(t);u.alpha=e},get theta(){return u.theta},set theta(e){let t=r.checkNumber(e,r.messages.THETA);if(!0!==t)throw new Error(t);u.theta=e},get step(){return u.step},set step(e){let t=r.checkStep(e);if(!0!==t)throw new Error(t);u.step=e},get iterCount(){return u.iterCount},set iterCount(e){let t=r.checkCount(e);if(!0!==t)throw new Error(t);u.iterCount=e},get rules(){let e=[...o].filter(([e])=>e>="A"&&e<="Z");return new Map(e)},setRule(e,t){let F=r.checkLetter(t);if(!0!==F)throw new Error(F);if(F=r.checkRule(e),!0!==F)throw new Error(F);o.set(t,e)},setRules(e){e.forEach(this.setRule,this)},deleteRule:e=>!("F"===e||"B"===e||!o.has(e))&&(o.delete(e),!0),get vacantLetters(){let e=new Set;for(let t of"ACDEGHIJKLMNOPQRSTUVWXYZ")o.has(t)||e.add(t);return e},reset(){n="",u=Object.assign({},i),o=new Map(s)}};h.reset();
/*!
lindsvg v1.0.0
https://amphiluke.github.io/l-systems/
(c) 2020 Amphiluke
*/
let c={AXIOM:"Axiom may only contain the following characters: A..Z,+,-,[,]",RULE:"Production rules may only contain the following characters: A..Z,+,-,[,]",LETTER:"Allowed alphabet letters are: A..Z",ALPHA:"The “alpha” parameter must be a finite number",THETA:"The “theta” parameter must be a finite number",STEP:"The “step” parameter must be a positive finite number",COUNT:"The number of iterations must be integer and finite",NUMBER:"A valid finite number expected"},p=/^[A-Z]$/;let m=/^[A-Z+\-[\]]*$/;function d(e,t=c.RULE){return m.test(e)||t}function X(e,t,F){let a=new Map;return Object.entries(e).forEach(([e,l])=>{let r=function(e,t=c.LETTER){return p.test(e)||t}(e,t);!0===r&&(r=d(l,F)),!0!==r&&a.set(e,r)}),!a.size||a}function g(e){let t=new Map;return Object.entries(e).forEach(([e,F])=>{let a=!0;switch(e){case"axiom":a=d(F,c.AXIOM);break;case"rules":a=X(F);break;case"alpha":case"theta":a=function(e,t=c.NUMBER){return Number.isFinite(e)||t}(F,c[e.toUpperCase()]);break;case"step":a=function(e,t=c.STEP){return Number.isFinite(e)&&e>0||t}(F);break;case"iterations":a=function(e,t=c.COUNT){return Number.isInteger(e)&&e>0||t}(F)}!0!==a&&t.set(e,a)}),!t.size||t}let Y={F:"",B:"","+":"+","-":"-","[":"[","]":"]"},f={alpha:0,theta:0,step:10,iterations:3};function C(e){let t=g(e);if(!0!==t)throw new Error(function e(t){return[...t].reduce((t,[F,a])=>a instanceof Map?`${t}\n${F}:${e(a).replace(/\n/g,"\n  ")}`:`${t}\n${F}: ${a}`,"")}(t));let{axiom:F,iterations:a}={...f,...e},l={...Y,...e.rules};for(;a>0;a--)F=[...F].reduce((e,t)=>e+(l[t]||""),"");return F}let x={translate(){this.x+=this.step*Math.cos(this.alpha),this.y+=this.step*Math.sin(this.alpha),this.minX=Math.min(this.minX,this.x),this.maxX=Math.max(this.maxX,this.x),this.minY=Math.min(this.minY,this.y),this.maxY=Math.max(this.maxY,this.y)},rotate(e){this.alpha+=e*this.theta},pushStack(){this.stack.push({x:this.x,y:this.y,alpha:this.alpha})},popStack(){({x:this.x,y:this.y,alpha:this.alpha}=this.stack.pop())},getDrawingRect(){let e=Math.floor(this.minX),t=Math.floor(this.minY),F=Math.ceil(this.maxX),a=Math.ceil(this.maxY);return{minX:e,minY:t,maxX:F,maxY:a,width:F-e,height:a-t}}};function L(e,t){return`${+e.toFixed(4)} ${+t.toFixed(4)}`}function k(e){let t=C(e),F=function({x:e,y:t,step:F,alpha:a,theta:l}){let r=Object.create(x);return r.stack=[],r.x=r.minX=r.maxX=e,r.y=r.minY=r.maxY=t,r.step=F,r.alpha=-a,r.theta=l,r}({x:0,y:0,...e});return{pathData:function(e,t){let F;return[...e].reduce((e,a)=>{switch(a){case"F":t.translate(),e+=("L"===F?" ":"L")+L(t.x,t.y),F="L";break;case"B":t.translate(),"M"===F&&(e=e.slice(0,e.lastIndexOf("M"))),e+="M"+L(t.x,t.y),F="M";break;case"+":t.rotate(1);break;case"-":t.rotate(-1);break;case"[":t.pushStack();break;case"]":t.popStack(),e+=`M${L(t.x,t.y)}`,F="M"}return e},"M"+L(t.x,t.y))}(function(e){return e.replace(/[^FB[\]+-]/g,"")}(t),F),...F.getDrawingRect()}}let b={plot(){let t={};h.rules.forEach((e,F)=>t[F]=e);let{pathData:F,minX:a,minY:l,width:r,height:s}=k({axiom:h.axiom,rules:t,alpha:h.alpha,theta:h.theta,iterations:h.iterCount,step:h.step}),i=e.ui.get("svg");i.setAttribute("viewBox",`${a-2} ${l-2} ${r+4} ${s+4}`),i.setAttribute("width",r.toString()),i.setAttribute("height",s.toString()),i.getElementsByTagName("path")[0].setAttribute("d",F)},setFGColor(t){e.ui.get("svg").getElementsByTagName("path")[0].setAttribute("stroke",t)},setBGColor(t){document.body.style.background=e.ui.get("svg").style.background=t}},y=new Map,v={get current(){return e.ui.get("collections").value},set current(t){e.ui.get("collections").value=t,v.fillLSystemList(),v.updateControlStates()},fillBank(){e.ui.get("collections").length=0;for(let e of Object.keys(a).sort())v.add(e,a[e],!1,!1);v.current=y.keys().next().value;let t=localStorage.getItem("userCollections");if(t){t=JSON.parse(t);for(let e of Object.keys(t).sort())v.add(e,t[e],!0,!1)}},fillLSystemList(t=v.current){let F="";for(let e of y.get(t).keys())F+=`<option>${e}</option>`;let a=e.ui.get("lSystems");a.innerHTML=F,a.selectedIndex=0},setupLSystem(e,t=v.current){let F=y.get(t).get(e);F&&(h.reset(),h.axiom=F.axiom,h.alpha=F.alpha*Math.PI/180,h.theta=F.theta*Math.PI/180,h.step=F.step,h.iterCount=F.iterCount,h.setRules(F.rules))},add(t,F={},a=!0,l=!0){t=v._getValidName(t,y);let r=v.plainToCollection(F);r.userDefined=a,y.set(t,r);let s=document.createElement("option");s.text=t,e.ui.get("collections").children[a?1:0].appendChild(s),l&&(v.current=t)},delete(t=v.current){if(!v.isUserDefined(t))throw new Error("Built in collection cannot be deleted");y.delete(t),t===v.current&&(v.current=y.keys().next().value);let F=e.ui.get("collections");F.children[1].removeChild([...F.options].find(e=>e.text===t))},isUserDefined:(e=v.current)=>!!y.get(e).userDefined,deleteLSystem(t,F=v.current){if(!v.isUserDefined(F))throw new Error("Built in collections cannot be modified");y.get(F).delete(t);let a=e.ui.get("lSystems");a.removeChild([...a.options].find(e=>e.text===t))},addLSystem(t,F=v.current){if(!v.isUserDefined(F))throw new Error("Built in collections cannot be modified");F=y.get(F),t=v._getValidName(t,F);let a=new Map;a.axiom=h.axiom,a.alpha=180*h.alpha/Math.PI,a.theta=180*h.theta/Math.PI,a.step=h.step,a.iterCount=h.iterCount,a.rules=h.rules,F.set(t,a);let l=document.createElement("option");l.text=t,e.ui.get("lSystems").add(l)},updateControlStates(){e.ui.get("deleteColl").disabled=e.ui.get("addLS").disabled=e.ui.get("removeLS").disabled=!v.isUserDefined()},storeUserCollections(){let e={};for(let t of y.keys())v.isUserDefined(t)&&(e[t]=v.collectionToPlain(t));localStorage.setItem("userCollections",JSON.stringify(e))},collectionToPlain(e=v.current){let t={};for(let[F,a]of y.get(e)){let e=t[F]={rules:{}};({axiom:e.axiom,alpha:e.alpha,theta:e.theta,iterCount:e.iterCount,step:e.step}=a);for(let[t,F]of a.rules)e.rules[t]=F}return t},plainToCollection(e){let t=new Map;for(let F of Object.keys(e).sort()){let a=e[F];a.rules=new Map(Object.keys(a.rules).map(e=>[e,a.rules[e]])),t.set(F,a)}return t},_getValidName(e,t){let F=2,a=e;for(;t.has(a);)a=`${e} (${F++})`;return a}};v.fillBank();let B={changeCollection(e){v.current=e.target.value},dblClickLSystem(e){v.setupLSystem(e.target.value),F.publish("LSystemConfigured")},keyDownLSystem({key:e,target:t}){switch(e){case"Enter":v.setupLSystem(t.value),F.publish("LSystemConfigured");break;case" ":v.setupLSystem(t.value),b.plot();break;case"Delete":v.isUserDefined()&&window.confirm("Delete the selected L-system?")&&v.deleteLSystem(t.value)}},clickCreateCollection(){let e=window.prompt("Enter a new collection name",`collection #${y.size+1}`);null!==e&&v.add(e)},clickDeleteCollection(){window.confirm("Delete the selected collection?")&&v.delete()},clickAddLS(){let e=window.prompt("Enter the name of the L-system","");null!==e&&v.addLSystem(e)},clickRemoveLS(){let t=e.ui.get("lSystems");t.selectedIndex>=0&&v.isUserDefined()&&window.confirm("Delete the selected L-system?")&&v.deleteLSystem(t.value)},changeImport(e){let t=new FileReader,F=e.target.files[0];t.addEventListener("load",()=>{let e=F.name.endsWith(".json")?F.name.slice(0,-5):F.name;v.add(e,JSON.parse(t.result))}),t.addEventListener("error",()=>{throw t.error}),t.readAsText(F)},mouseDownExport({target:e}){URL.revokeObjectURL(e.href);let t=[JSON.stringify(v.collectionToPlain(),null,2)],F=new Blob(t,{type:"application/json"});e.href=URL.createObjectURL(F),e.download=`${v.current}.json`},beforeUnload(){v.storeUserCollections()}};e.ui.get("collections").addEventListener("change",B.changeCollection),e.ui.get("lSystems").addEventListener("dblclick",B.dblClickLSystem),e.ui.get("lSystems").addEventListener("keydown",B.keyDownLSystem),e.ui.get("createColl").addEventListener("click",B.clickCreateCollection),e.ui.get("deleteColl").addEventListener("click",B.clickDeleteCollection),e.ui.get("addLS").addEventListener("click",B.clickAddLS),e.ui.get("removeLS").addEventListener("click",B.clickRemoveLS),e.ui.get("importColl").addEventListener("change",B.changeImport),e.ui.get("exportColl").addEventListener("mousedown",B.mouseDownExport),window.addEventListener("beforeunload",B.beforeUnload);let w=e.ui.get(".panels").get("settings"),S=e.ui.get("letterPopup"),E=w.querySelector(".ls-rules"),A={tpl:e.ui.get("ruleTpl"),delete(e){if(h.deleteRule(e)){let t=E.querySelector(`[data-mark="${e}"]`),F=t.previousElementSibling.querySelector("input");F.focus(),F.selectionStart=F.selectionEnd=F.value.length,t.parentNode.removeChild(t)}},insert(e,t=A.tpl){if(!e)return;let F=A.tpl.innerHTML.replace(/\${(?:letter|rule)}/g,e);t.insertAdjacentHTML("beforebegin",F),h.setRule(e,e);let a=E.querySelector(`input[data-letter="${e}"]`);a.focus(),a.select()},replace(e,t){if(h.deleteRule(e)){h.setRule(t,t);let F=E.querySelector(`[data-mark="${e}"]`),a=E.querySelector(`input[data-letter="${e}"]`);F.dataset.mark=t,a.dataset.letter=t,a.focus()}},sync(){[...E.querySelectorAll("[data-mark]:not([data-mark='F']):not([data-mark='B'])")].forEach(e=>e.parentNode.removeChild(e));let e=A.tpl.innerHTML;for(let[t,F]of h.rules)if("F"===t||"B"===t)E.querySelector(`input[data-letter="${t}"]`).value=F;else{let a=e.replace(/\${letter}/g,t).replace(/\${rule}/g,F);A.tpl.insertAdjacentHTML("beforebegin",a)}}},W={clickAddRule(){A.insert([...h.vacantLetters][0])},keyDownBackspace(e){let t=e.target,F=t.dataset.letter;F&&!t.value&&(A.delete(F),e.preventDefault())},keyDownDelete(e){e.ctrlKey&&A.delete(e.target.dataset.letter)},keyDownInsert(e){let t=e.target.dataset.letter;if(t){let e="F"===t?void 0:E.querySelector(`[data-mark="${t}"]`).nextElementSibling;A.insert([...h.vacantLetters][0],e)}},clickRuleLetter({target:e}){let t=e.dataset.mark;if(t&&"F"!==t&&"B"!==t){if(!S.classList.contains("visible")){let e=h.vacantLetters;[...S.getElementsByTagName("button")].forEach(t=>{t.disabled=t.value&&!e.has(t.value)})}S.classList.toggle("visible"),S.classList.contains("visible")&&(S.style.left=`${e.offsetLeft}px`,S.style.top=`${e.offsetTop+e.offsetHeight}px`,S.dataset.ownerLetter=t)}},clickPopupBtn(e){let t=e.target.value,F=S.dataset.ownerLetter;t?A.replace(F,t):A.delete(F),S.classList.remove("visible")},clickPlot(t){t.preventDefault();let F=[...E.querySelectorAll("input[data-letter]")],a=new Map(F.map(e=>[e.dataset.letter,e.value.toUpperCase()]));try{h.reset(),h.axiom=e.ui.get("axiom").value.toUpperCase(),h.alpha=e.ui.get("alpha").value*Math.PI/180,h.theta=e.ui.get("theta").value*Math.PI/180,h.step=Number(e.ui.get("step").value),h.iterCount=Number(e.ui.get("iterCount").value),h.setRules(a)}catch(e){return void alert(e.message)}b.plot()},syncLSystem(){e.ui.get("axiom").value=h.axiom,e.ui.get("alpha").value=(180*h.alpha/Math.PI).toFixed(3),e.ui.get("theta").value=(180*h.theta/Math.PI).toFixed(3),e.ui.get("step").value=h.step,e.ui.get("iterCount").value=h.iterCount,A.sync()}};e.ui.get("addRule").addEventListener("click",W.clickAddRule),E.addEventListener("keydown",e=>{let t=`keyDown${e.key}`;Object.prototype.hasOwnProperty.call(W,t)&&W[t](e)}),E.addEventListener("click",W.clickRuleLetter),S.addEventListener("click",W.clickPopupBtn),e.ui.get("plot").addEventListener("click",W.clickPlot),F.subscribe("LSystemConfigured",W.syncLSystem);let R={changeFg(e){b.setFGColor(e.target.value)},changeBg(e){b.setBGColor(e.target.value)},toggleTransparency(t){let F=e.ui.get("bgClr"),a=F.disabled=t.target.checked;b.setBGColor(a?"transparent":F.value)}};e.ui.get("fgClr").addEventListener("change",R.changeFg),e.ui.get("bgClr").addEventListener("change",R.changeBg),e.ui.get("noBgClr").addEventListener("change",R.toggleTransparency);let T={getLSystemLink(){let e=`${location.origin}${location.pathname}?~ls~=`;e+=`ax${encodeURIComponent(h.axiom)}~`;for(let[t,F]of h.rules)e+=`r${t}${encodeURIComponent(F)}~`;return e+=`al${(180*h.alpha/Math.PI).toFixed(3)}~`,e+=`th${(180*h.theta/Math.PI).toFixed(3)}~`,e+=`it${h.iterCount}~`,e+=`st${h.step}`,e},checkURLQuery(){let e=location.search.match(/[?&]~ls~=([^&]+)/);if(e){h.reset();for(let t of e[1].split("~")){let e=t.slice(0,2),F=decodeURIComponent(t.slice(2));switch(e){case"ax":h.axiom=F;break;case"al":h.alpha=F*Math.PI/180;break;case"th":h.theta=F*Math.PI/180;break;case"it":h.iterCount=+F;break;case"st":h.step=+F;break;default:"r"===e[0]&&h.setRule(F,e[1])}}F.publish("LSystemConfigured"),b.plot()}}},M={mouseDownExport({target:t}){URL.revokeObjectURL(t.href);let F=new Blob([e.ui.get("svg").outerHTML],{type:"image/svg+xml"});t.href=URL.createObjectURL(F)},clickMakeLink(){let t=e.ui.get("linkAddress");t.value=T.getLSystemLink(),t.focus(),t.select()},focusLinkAddress(e){e.target.select()}};e.ui.get("exportImg").addEventListener("mousedown",M.mouseDownExport),e.ui.get("makeLink").addEventListener("click",M.clickMakeLink),e.ui.get("linkAddress").addEventListener("focus",M.focusLinkAddress),T.checkURLQuery();let Z=[...e.ui.get(".panels").values()].find(e=>e.classList.contains("ls-panel-open")),N={show(t,F=!1){let a=e.ui.get(".panels").get(t);a&&(a!==Z?(Z&&Z.classList.remove("ls-panel-open"),a.classList.add("ls-panel-open"),Z=a):F&&this.hide())},hide(){Z&&(Z.classList.remove("ls-panel-open"),Z=null)}};e.ui.get("tabs").addEventListener("click",e=>{let t=e.target.dataset.lsRef;t&&N.show(t,!0)}),F.subscribe("LSystemConfigured",()=>{N.show("settings")}),window.innerWidth>=980&&N.show("collections");
