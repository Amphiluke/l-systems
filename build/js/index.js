let e=new Map;function t(t,a,F){("string"==typeof t?e.get(t):t).addEventListener(a,F)}[...document.body.querySelectorAll("[data-lsid]")].forEach(t=>{!function(t,a){e.set(a,t);let F=a.indexOf(".");if(F>0){let l=a.slice(F),r=e.get(l);r||(r=new Map,e.set(l,r)),r.set(a.slice(0,F),t)}}(t,t.dataset.lsid)});let a=new Map;function F(e,...t){let F=a.get(e);F&&F.forEach(e=>e(...t))}function l(e,t){if(e.includes(" "))return void e.split(" ").forEach(e=>l(e,t));let F=a.get(e);F||(F=[],a.set(e,F)),F.push(t)}let r={Plants:{"bush 1":{axiom:"F",rules:{F:"F[+FF][-FF]F[-F][+F]F"},alpha:90,theta:35,iterCount:4,step:6},"bush 2":{axiom:"F",rules:{F:"FF+[+F-F-F]-[-F+F+F]"},alpha:90,theta:22.5,iterCount:4,step:9},sticks:{axiom:"X",rules:{F:"FF",X:"F[+X]F[-X]+X"},alpha:90,theta:20,iterCount:7,step:2},"plant 1":{axiom:"X",rules:{F:"FF",X:"F-[[X]+X]+F[+FX]-X"},alpha:90,theta:25,iterCount:6,step:3},"plant 2":{axiom:"F",rules:{F:"F[+F]F[-F][F]"},alpha:90,theta:20,iterCount:5,step:8},"plant 3":{axiom:"X",rules:{F:"FF",X:"F[+X][-X]FX"},alpha:90,theta:25.71,iterCount:6,step:3.5},"savine 1":{axiom:"F-F[-F+F-F]+[+F-F-F]",rules:{F:"-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:3,step:3},"savine 2":{axiom:"-[F-F[-F+F-F]+[+F-F-F]]+[F-F[-F+F-F]+[+F-F-F]]",rules:{F:"-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:3,step:3},"liana sarment":{axiom:"FYX",rules:{F:"FFFXYFXY-[FFFXYFXY]",X:"Y[[XY]+X]+F[+FX]+XF",Y:"[FFF[[YX]+Y]+F[+FY]+F]"},alpha:90,theta:20,iterCount:4,step:.5},"liana tangle":{axiom:"FYX",rules:{F:"FFFXYFXY-[FFFXYFXY]",X:"Y[[XY]+X]+F[+FX]+XF",Y:"FFF[[YX]+Y]+F[+FY]+F"},alpha:90,theta:20,iterCount:4,step:2},tree:{axiom:"F",rules:{F:"-F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:5,step:15},weed:{axiom:"F",rules:{F:"F[+F]F[-F]F"},alpha:90,theta:25.714,iterCount:5,step:2},"flower 1":{axiom:"F[+F+F][-F-F][++F][--F]F",rules:{F:"FF[++F][+F][F][-F][--F]"},alpha:90,theta:11.25,iterCount:3,step:15},"bush 3":{axiom:"VZFFF",rules:{F:"F",V:"[+++W][---W]YV",W:"+X[-W]Z",X:"-W[+X]Z",Y:"YZ",Z:"[-FFF][+FFF]F"},alpha:90,theta:20,iterCount:9,step:10},algae:{axiom:"AF",rules:{A:"FFFFFV[+++H][---Q]BW",B:"B",C:"FFFFFV[+++BA]BD",D:"FFFFFV[+++H][---Q]BE",E:"FFFFFV[+++H][---Q]BG",F:"F",G:"FFFFFV[---BA]BA",H:"IBFF",I:"BFFF[--M]J",J:"BFFF[--N]K",K:"BFFF[--O]L",L:"BFFF[--P]",M:"BFN",N:"BFO",O:"BFP",P:"BF",Q:"RBF",R:"BFFF[++M]S",S:"BFFF[++N]T",T:"BFFF[++O]U",U:"BFFF[++P]",V:"FV",W:"FFFFFV[+++H][---Q]BC"},alpha:90,theta:12,iterCount:17,step:2},"algae 2":{axiom:"AF",rules:{A:"FFFFFY[++++N][----T]BZ",B:"B",C:"FFFFFY[++++N][----T]BD",D:"FFFFFY[++++N][----T]BE",E:"FFFFFY[++++N][----T]BG",F:"F",G:"FFFFFY[+++BA]BH",H:"FFFFFY[++++N][----T]BI",I:"+FFFFFY[++++N][----T]BJ",J:"FFFFFY[++++N][----T]BK",K:"-FFFFFY[++++N][----T]BL",L:"FFFFFY[++++N][----T]BM",M:"FFFFFY[---BA]BA",N:"OBFFF",O:"BFFFP",P:"BFFF[-S]Q",Q:"BFFF[-S]R",R:"BFFF[-S]",S:"BFBF",T:"UBFFF",U:"BFFFV",V:"BFFF[+S]W",W:"BFFF[+S]X",X:"BFFF[+S]",Y:"FY",Z:"+FFFFFY[++++N][----T]BC"},alpha:90,theta:12,iterCount:17,step:2},"plant 4":{axiom:"--------C",rules:{F:"F",C:"NF[--P]F+C",N:"NFF",P:"Q",Q:"C"},alpha:0,theta:11.25,iterCount:20,step:1.2},"plant 5":{axiom:"----G",rules:{F:"F",G:"GFX[+G][-G]",X:"X[-FFF][+FFF]FX"},alpha:0,theta:25.7,iterCount:6,step:4},dandelion:{axiom:"FF[-Y][Z][+Z]",rules:{F:"F",Y:"FF+F-F-F[FFFZ][+Z]-F-FZ",Z:"FF-F+F+F[Y][-Y]+F+FY"},alpha:90,theta:15,iterCount:6,step:6},sapling:{axiom:"FFFFFFX",rules:{F:"F",X:"FFF-[-F+F[Y]-[X]]+[+F+F[X]-[X]]",Y:"FF-[-F+F]+[+F+FY]"},alpha:90,theta:15,iterCount:6,step:10},"flower 2":{axiom:"F-F+F[++X][F+X][F-X][--X]",rules:{F:"F",W:"F-F+F[++X][F+X][F-X][--X]",X:"F+FF-F[++Y][+Y][-Z][--Z]",Y:"-[Z]F-FF-FF-FF-F[Z]",Z:"+[Y]F+FF+FF+FF+F[Y]"},alpha:90,theta:10,iterCount:9,step:4.5},"bonsai branch":{axiom:"A",rules:{F:"F",A:"F-FFA+[FAFA+FFF]F"},alpha:90,theta:30,iterCount:5,step:7}},Curves:{"Hilbert curve":{axiom:"X",rules:{F:"F",X:"-YF+XFX+FY-",Y:"+XF-YFY-FX+"},alpha:0,theta:90,iterCount:6,step:7},"Gosper curve":{axiom:"XF",rules:{F:"F",X:"X+YF++YF-FX--FXFX-YF+",Y:"-FX+YFYF++YF+FX--FX-Y"},alpha:0,theta:60,iterCount:4,step:8},"Peano curve":{axiom:"F",rules:{F:"F-F+F+F+F-F-F-F+F"},alpha:45,theta:90,iterCount:4,step:8},"Sierpinski curve":{axiom:"F+FX+F+XF",rules:{F:"F",X:"XF-F+F-XF+F+XF-F+F-X"},alpha:45,theta:90,iterCount:4,step:8},curve:{axiom:"F-F-F-F-",rules:{F:"FF-F-F-F-F-F+F"},alpha:0,theta:90,iterCount:4,step:3.5},cross:{axiom:"FX",rules:{X:"FX+FX+FXFY-FY-",Y:"+FX+FXFY-FY-FY"},alpha:0,theta:90,iterCount:5,step:4.5},island:{axiom:"F+F+F+F",rules:{F:"F+F-F-FFF+F+F-F"},alpha:0,theta:90,iterCount:3,step:4},"Koch’s snowflake":{axiom:"F++F++F",rules:{F:"F-F++F-F"},alpha:0,theta:60,iterCount:4,step:5},"Koch’s curve":{axiom:"F+F+F+F",rules:{F:"FF+F+F+F+F+F-F"},alpha:0,theta:90,iterCount:4,step:3.5},chain:{axiom:"F+F+F+F",rules:{F:"F+B-F-FFF+F+B-F",B:"BBB"},alpha:0,theta:90,iterCount:3,step:4},frame:{axiom:"YXY-YXY-YXY-YXY",rules:{X:"FX+FX+FXFYFX+FXFY-FY-FY-",Y:"+FX+FX+FXFY-FYFXFY-FY-FY"},alpha:0,theta:90,iterCount:3,step:4},"Moore’s curl":{axiom:"X",rules:{X:"FX+FX+FXFYFX+FXFY-FY-FY-",Y:"+FX+FX+FXFY-FYFXFY-FY-FY"},alpha:180,theta:90,iterCount:4,step:3.5},"anklets of Krishna":{axiom:"-X--X",rules:{F:"F",X:"XFX--XFX"},alpha:0,theta:45,iterCount:5,step:10},"mango-tree foliage":{axiom:"A---A",rules:{F:"F",B:"B",A:"B-F+Z+F-BA",Z:"F-FF-F--[--Z]F-FF-F--F-FF-F--"},alpha:0,theta:60,iterCount:7,step:15},pentive:{axiom:"Q",rules:{P:"--FR++++FS--FU",Q:"FT++FR----FS++",R:"++FP----FQ++FT",S:"FU--FP++++FQ--",T:"+FU--FP+",U:"-FQ++FT-"},alpha:36,theta:36,iterCount:7,step:15},"Sierpinski median curve":{axiom:"L--F--L--F",rules:{F:"F",L:"+R-F-R+",R:"-L+F+L-"},alpha:0,theta:45,iterCount:10,step:5},lace:{axiom:"W",rules:{F:"F",W:"+++X--F--ZFX+",X:"---W++F++YFW-",Y:"+ZFX--F--Z+++",Z:"-YFW++F++Y---"},alpha:180,theta:30,iterCount:7,step:4.5},"Peano-c":{axiom:"+Z",rules:{X:"FX-FY-FX+FY+FX+FY+FX+FY+FX-FY-FX-FY-FX-FY-FX+FY+FX",Y:"FY",Z:"FX"},alpha:0,theta:45,iterCount:5,step:3.5},"Hex-7-b":{axiom:"FX",rules:{X:"-F++F-X-F--F+Y---F--F+Y+F++F-X+++F++F-X-F++F-X+++F--F+Y--",Y:"+F++F-X-F--F+Y+F--F+Y---F--F+Y---F++F-X+++F++F-X+++F--F+Y"},alpha:0,theta:30,iterCount:4,step:5}},Shapes:{"Sierpinski carpet":{axiom:"F+F+F",rules:{F:"F[+F]F"},alpha:180,theta:120,iterCount:6,step:8},mosaic:{axiom:"F-F-F-F",rules:{F:"F-B+FF-F-FF-FB-FF+B-FF+F+FF+FB+FFF",B:"BBBBBB"},alpha:0,theta:90,iterCount:2,step:7},snowflake:{axiom:"[F]+[F]+[F]+[F]+[F]+[F]",rules:{F:"F[++F][-FF]FF[+F][-F]FF"},alpha:0,theta:60,iterCount:3,step:2},crystal:{axiom:"F+F+F+F",rules:{F:"FF+F++F+F"},alpha:0,theta:90,iterCount:4,step:5},pentigree:{axiom:"F-F-F-F-F",rules:{F:"F-F++F+F-F-F"},alpha:0,theta:72,iterCount:4,step:5},square:{axiom:"F+F+F+F",rules:{F:"FF+F+F+F+FF"},alpha:0,theta:90,iterCount:4,step:5},"fluffy globule":{axiom:"X-X-X-X-X-X-X-X-X",rules:{X:"FX+X--X+X--X+X--X+X"},alpha:0,theta:40,iterCount:4,step:18},horizons:{axiom:"+F++++F",rules:{F:"F+F+F++++F+F+F"},alpha:0,theta:45,iterCount:5,step:1.3},napkin:{axiom:"F--F--F--F--F--F",rules:{F:"-F[--F--F]++F--F+"},alpha:0,theta:30,iterCount:4,step:4.5},"Levi’s fractal":{axiom:"F",rules:{F:"+F--F+"},alpha:180,theta:45,iterCount:14,step:1.9},"Levi’s carpet":{axiom:"F++F++F++F",rules:{F:"+F--F+"},alpha:180,theta:45,iterCount:14,step:1.8},"spiral tiling":{axiom:"AAAA",rules:{F:"F",A:"X+X+X+X+X+X+",X:"[F+F+F+F[---X-Y]+++++F++++++++F-F-F-F]",Y:"[F+F+F+F[---Y]+++++F++++++++F-F-F-F]"},alpha:0,theta:15,iterCount:5,step:10},"Penrose mosaic":{axiom:"+WF--XF---YF--ZF",rules:{W:"YF++ZF----XF[-YF----WF]++",X:"+YF--ZF[---WF--XF]+",Y:"-WF++XF[+++YF++ZF]-",Z:"--YF++++WF[+ZF++++XF]--XF"},alpha:270,theta:36,iterCount:6,step:11},"Penrose tesselation":{axiom:"[X]++[X]++[X]++[X]++[X]",rules:{W:"YF++ZF----XF[-YF----WF]++",X:"+YF--ZF[---WF--XF]+",Y:"-WF++XF[+++YF++ZF]-",Z:"--YF++++WF[+ZF++++XF]--XF"},alpha:0,theta:36,iterCount:5,step:20},"snowflake 2":{axiom:"F[X]F++F[X]F++F[X]F++F[X]F",rules:{X:"[+Y][-Y][++Y][--Y]",Y:"YF[X]YF"},alpha:0,theta:45,iterCount:9,step:1},wheel:{axiom:"WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW",rules:{W:"F[X]+",X:"[+++++++++++++Y[X]]-------------Y[X]",Y:"YFYF"},alpha:0,theta:5,iterCount:8,step:2},"hexagonal star":{axiom:"S",rules:{L:"LZFR--FR-F++LF++L-F+LF+R--Y",R:"Z++L-FR-F+R--FR--F+LF++LFYR",S:"L",Y:"+",Z:"-"},alpha:0,theta:60,iterCount:6,step:4.75},HexGasket:{axiom:"F+F+F+F+F+F--",rules:{F:"F+F+F--F--F+F+F"},alpha:0,theta:60,iterCount:4,step:3}},Dragons:{dragon:{axiom:"FX",rules:{F:"F",X:"X+YF+",Y:"-FX-Y"},alpha:0,theta:90,iterCount:12,step:5},terdragon:{axiom:"F",rules:{F:"F+F-F"},alpha:120,theta:120,iterCount:8,step:6},"median dragon":{axiom:"-X",rules:{F:"F",X:"X+F+Y",Y:"X-F-Y"},alpha:0,theta:45,iterCount:12,step:3}},Miscellaneous:{urchin:{axiom:"F",rules:{F:"F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:5,step:15},"Cesaro 1":{axiom:"F",rules:{F:"F++++++++++F--------------------F++++++++++F"},alpha:180,theta:8,iterCount:6,step:2.9},"Cesaro 2":{axiom:"AAAA",rules:{A:"F+++++++++F------------------",F:"F++++++++F----------------F++++++++F"},alpha:0,theta:10,iterCount:6,step:4}}};class s{constructor({lSystems:e=new Map,userDefined:t=!0}={}){Object.defineProperties(this,{userDefined:{enumerable:!0,value:t},lSystems:{value:e}})}addLSystem(e,t){if(!this.userDefined)throw new Error("Built in collection cannot be modified");this.lSystems.set(e,t)}removeLSystem(e){if(!this.userDefined)throw new Error("Built in collection cannot be modified");return this.lSystems.delete(e)}toJSON(){let e={};return this.lSystems.forEach((t,a)=>{let F=e[a]={rules:{}};({axiom:F.axiom,alpha:F.alpha,theta:F.theta,iterCount:F.iterCount,step:F.step}=t),t.rules.forEach((e,t)=>{F.rules[t]=e})}),e}static fromJSON(e,t){let a=new Map;return Object.keys(e).sort().forEach(t=>{let F=Object.assign({},e[t]);F.rules=new Map(Object.entries(F.rules)),a.set(t,F)}),new s({lSystems:a,userDefined:t})}}let o={bank:new Map,fillBank(){Object.keys(r).sort().forEach(e=>{o.add(e,r[e],!1)});let e=localStorage.getItem("userCollections");if(!e)return;let t={};try{t=JSON.parse(e)}catch(e){localStorage.removeItem("userCollections"),console.error("Cannot parse stored user collections")}Object.keys(t).sort().forEach(e=>{o.add(e,t[e])})},add(e,t={},a=!0){e=o.getValidName(e,o.bank),o.bank.set(e,s.fromJSON(t,a)),a&&o.storeUserCollections(),F("collectionAdded",e)},remove(e){if(o.bank.has(e)){if(!o.isUserDefined(e))throw new Error("Built in collection cannot be deleted");o.bank.delete(e),o.storeUserCollections(),F("collectionRemoved",e)}},isUserDefined:e=>o.bank.get(e).userDefined,addLSystem(e,t,a){o.bank.has(a)&&(e=o.getValidName(e,o.bank.get(a).lSystems),o.bank.get(a).addLSystem(e,t),o.storeUserCollections(),F("LSystemAdded",e,a))},removeLSystem(e,t){o.bank.has(t)&&o.bank.get(t).removeLSystem(e)&&(o.storeUserCollections(),F("LSystemRemoved",e,t))},storeUserCollections(){let e={};o.bank.forEach((t,a)=>{t.userDefined&&(e[a]=t)}),localStorage.setItem("userCollections",JSON.stringify(e))},getValidName(e,t){let a=2,F=e;for(;t.has(F);)F=`${e} (${a++})`;return F}};function i(e="all"){let t=[...o.bank.keys()];return"built in"===e?t.filter(e=>!o.isUserDefined(e)):"user defined"===e?t.filter(e=>o.isUserDefined(e)):t}function n(e){return o.isUserDefined(e)}function c(e,t){o.add(e,t)}function u(e,t){o.removeLSystem(e,t)}function p(e){let t=o.bank.get(e);return t?t.toJSON():null}o.fillBank();let h={AXIOM:"The axiom may contain only the following characters: “A”-Z”, “+”, “-”, “[”, “]”",RULE:"Production rules may may contain only the following characters: “A”-Z”, “+”, “-”, “[”, “]”",LETTER:"The allowed alphabet letters are: “A”-“Z”",ALPHA:"The “alpha” parameter must be a finite number",THETA:"The “theta” parameter must be a finite number",STEP:"The “step” parameter must be a positive finite number",COUNT:"The number of iterations must be integer and finite",NUMBER:"A valid finite number expected"},m=/^[A-Z+\-[\]]*$/;function d(e,t=h.RULE){return m.test(e)||t}let g=/^[A-Z]$/;function f(e,t=h.NUMBER){return Number.isFinite(e)||t}const X=[["F",""],["B",""],["+","+"],["-","-"],["[","["],["]","]"]],C={alpha:0,theta:0,step:10,iterCount:3};let Y,y,k,x={get axiom(){return Y},set axiom(e){let t=d(e,h.AXIOM);if(!0!==t)throw new Error(t);Y=e},get alpha(){return k.alpha},set alpha(e){let t=f(e,h.ALPHA);if(!0!==t)throw new Error(t);k.alpha=e},get theta(){return k.theta},set theta(e){let t=f(e,h.THETA);if(!0!==t)throw new Error(t);k.theta=e},get step(){return k.step},set step(e){let t=function(e,t=h.STEP){return Number.isFinite(e)&&e>0||t}(e);if(!0!==t)throw new Error(t);k.step=e},get iterCount(){return k.iterCount},set iterCount(e){let t=function(e,t=h.COUNT){return Number.isInteger(e)&&e>0||t}(e);if(!0!==t)throw new Error(t);k.iterCount=e},get rules(){let e=[...y].filter(([e])=>/[A-Z]/.test(e));return new Map(e)},setRule(e,t){let a=function(e,t=h.LETTER){return g.test(e)||t}(t);if(!0!==a)throw new Error(a);if(!0!==(a=d(e)))throw new Error(a);y.set(t,e)},setRules(e){e.forEach(x.setRule,x)},deleteRule:e=>"F"!==e&&"B"!==e&&y.delete(e),get vacantLetters(){let e=new Set;for(let t of"ACDEGHIJKLMNOPQRSTUVWXYZ")y.has(t)||e.add(t);return e},getCode(){let e=Y;for(let t=k.iterCount;t>0;t--){let t="";for(let a of e)t+=y.get(a)||"";e=t}return e},reset(){Y="",k=Object.assign({},C),y=new Map(X)}};x.reset();let L=e.get("canvas"),S=L.getContext("2d"),b=window.matchMedia("(-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi)").matches?2:1,B={stack:[]},v=new Map;v.set("F",()=>{B.x+=B.step*Math.cos(B.alpha),B.y+=B.step*Math.sin(B.alpha),S.lineTo(B.x,B.y)}),v.set("B",()=>{B.x+=B.step*Math.cos(B.alpha),B.y+=B.step*Math.sin(B.alpha),S.moveTo(B.x,B.y)}),v.set("+",()=>{B.alpha+=B.theta}),v.set("-",()=>{B.alpha-=B.theta}),v.set("[",()=>{B.stack.push({x:B.x,y:B.y,alpha:B.alpha})}),v.set("]",()=>{({x:B.x,y:B.y,alpha:B.alpha}=B.stack.pop()),S.moveTo(B.x,B.y)});let w=new Map([...v]);w.set("F",()=>{B.x+=B.step*Math.cos(B.alpha),B.y+=B.step*Math.sin(B.alpha),B.left=Math.min(B.left,B.x),B.right=Math.max(B.right,B.x),B.top=Math.min(B.top,B.y),B.bottom=Math.max(B.bottom,B.y)}),w.set("B",w.get("F")),w.set("]",()=>{({x:B.x,y:B.y,alpha:B.alpha}=B.stack.pop())});let W={settings:{fillStyle:"transparent",strokeStyle:"#080"},reset(){B.cleanCode="",B.x=B.y=0,({step:B.step,alpha:B.alpha,theta:B.theta,iterCount:B.count}=x),B.step*=b,B.stack.length=0,B.left=B.top=Number.MAX_VALUE,B.right=B.bottom=-Number.MAX_VALUE},prepare(){let e=x.getCode(),t="";for(let a of e){let e=w.get(a);e&&(t+=a,e())}B.cleanCode=t},setup(){B.x=(L.offsetWidth-B.left-B.right)/2,B.y=(L.offsetHeight-B.top-B.bottom)/2,B.alpha=x.alpha,B.stack.length=0},clear(){S.strokeStyle=this.settings.strokeStyle,S.fillStyle=this.settings.fillStyle,S.clearRect(0,0,L.offsetWidth,L.offsetHeight),S.fillRect(0,0,L.offsetWidth,L.offsetHeight)},repaint(){if(this.clear(),B.cleanCode){this.setup(),S.beginPath(),S.moveTo(B.x,B.y);for(let e of B.cleanCode)v.get(e)();S.stroke()}},plot(){this.reset(),this.prepare(),this.repaint()}};const A=!!navigator.clipboard;function R(e){return A?navigator.clipboard.writeText(e):Promise.reject("Clipboard API is not supported in this browser")}let E={get current(){return e.get("collections").value},set current(t){let a=e.get("collections");t?(a.value=t,E.filterLSystemsByCollection(t)):(a.selectedIndex=-1,E.filterLSystemsByName("")),E.updateControlStates()},init(){l("collectionAdded",e=>{E.fillCollections(),E.current=e}),l("collectionRemoved",e=>{let{current:t}=E;E.fillCollections(),e===t&&(t=i()[0]),E.current=t}),l("LSystemAdded LSystemRemoved",()=>{let{current:e}=E;E.fillLSystemList(),E.current=e}),E.fillCollections(),E.current=i()[0]},fillCollections(){let t=e.get("collections"),a=(e,t)=>`${e}<option>${t}</option>`;t.children[0].innerHTML=i("built in").reduce(a,""),t.children[1].innerHTML=i("user defined").reduce(a,""),E.fillLSystemList()},fillLSystemList(){let t=e.get("lSystems");t.innerHTML=function(){let e=[];return o.bank.forEach((t,a)=>{t.lSystems.forEach((t,F)=>{e.push({name:F,collection:a})})}),e}().reduce((e,{name:t,collection:a})=>`${e}<option value="${t}::${a}">${t}</option>`,""),t.selectedIndex=0},filterLSystemsByCollection(t=E.current){[...e.get("lSystems").options].forEach(e=>{e.classList.toggle("hidden",!e.value.endsWith("::"+t))}),E.updateSelected()},filterLSystemsByName(t){[...e.get("lSystems").options].forEach(e=>{e.classList.toggle("hidden",!!t&&!e.text.includes(t))}),E.updateSelected()},updateSelected(){let t=[...e.get("lSystems").options],a=t.find(e=>e.selected);if(a&&a.classList.contains("hidden")){let e=t.find(e=>!e.classList.contains("hidden"));e&&(e.selected=!0)}},setupLSystem(e,t=E.current){let a=function(e,t){let a=o.bank.get(t);return a&&a.lSystems.get(e)}(e,t);a&&(x.reset(),x.axiom=a.axiom,x.alpha=-a.alpha*Math.PI/180,x.theta=a.theta*Math.PI/180,x.step=a.step,x.iterCount=a.iterCount,x.setRules(a.rules))},updateControlStates(){let t=!!E.current&&n(E.current),a=e.get("collections.panels");[...a.querySelectorAll("[data-for='userDefined']")].forEach(e=>e.disabled=!t),[...a.querySelectorAll("[data-for='builtIn']")].forEach(e=>e.disabled=t)}};E.init();let T={changeCollection(e){E.current=e.target.value},clickToggleSearch(){let t=e.get("collections.panels");t.classList.toggle("ls-search-mode"),t.classList.contains("ls-search-mode")?E.current="":E.current=i()[0]},searchLS(){E.filterLSystemsByName(e.get("searchLS").value)},clickExplore(){E.setupLSystem(...e.get("lSystems").value.split("::")),F("LSystemConfigured")},clickView(){E.setupLSystem(...e.get("lSystems").value.split("::")),W.plot()},clickPermalink(){let t=e.get("lSystems").value;R(`${location.origin}${location.pathname}?ls=${encodeURIComponent(t)}`).then(()=>{e.get("permalink.clipboard").classList.add("copied")}).catch(()=>{e.get("permalink.clipboard").classList.add("failed")}).then(()=>{setTimeout(()=>{e.get("permalink.clipboard").classList.remove("copied","failed")},2e3)})},keyDownLSystem({key:e,target:t}){switch(e){case"Enter":T.clickExplore();break;case" ":T.clickView();break;case"Delete":n(E.current)&&window.confirm("Delete the selected L-system?")&&u(t.text,E.current)}},clickCreateCollection(){let e=window.prompt("Enter a new collection name",`collection #${i().length+1}`);e&&c(e)},clickDeleteCollection(){var e;window.confirm("Delete the selected collection?")&&(e=E.current,o.remove(e))},clickAddLS(){let e=window.prompt("Enter the name of the L-system","");if(e){!function(e,t,a){o.addLSystem(e,t,a)}(e,{axiom:x.axiom,alpha:180*-x.alpha/Math.PI,theta:180*x.theta/Math.PI,step:x.step,iterCount:x.iterCount,rules:x.rules},E.current)}},clickRemoveLS(){let t=e.get("lSystems");t.selectedIndex>=0&&n(E.current)&&window.confirm("Delete the selected L-system?")&&u(t.options[t.selectedIndex].text,E.current)},changeImport(e){let t=new FileReader,a=e.target.files[0];t.addEventListener("load",()=>{c(a.name.endsWith(".json")?a.name.slice(0,-5):a.name,JSON.parse(t.result))}),t.addEventListener("error",()=>{throw t.error}),t.readAsText(a)},mouseDownExport({target:e}){URL.revokeObjectURL(e.href);let t=[JSON.stringify(p(E.current),null,2)],a=new Blob(t,{type:"application/json"});e.href=URL.createObjectURL(a),e.download=`${E.current}.json`}};if(t("collections","change",T.changeCollection),t("toggleSearch","click",T.clickToggleSearch),t("searchLS","input",T.searchLS),t("lSystems","keydown",T.keyDownLSystem),t("lSystems","dblclick",T.clickExplore),t("explore","click",T.clickExplore),t("view","click",T.clickView),t(e.get("permalink.clipboard"),"click",T.clickPermalink),t("createColl","click",T.clickCreateCollection),t("deleteColl","click",T.clickDeleteCollection),t("addLS","click",T.clickAddLS),t("removeLS","click",T.clickRemoveLS),t("importColl","change",T.changeImport),t("exportColl","mousedown",T.mouseDownExport),t("exportColl","touchstart",T.mouseDownExport),/[?&]ls=([^&]+)/.exec(location.search)){let t=decodeURIComponent(RegExp.$1),a=e.get("lSystems").querySelector(`option[value="${t}"]`);a&&(E.current=t.split("::")[1],a.selected=!0,T.clickView())}let M=e.get("settings.panels"),P=e.get("letterPopup"),N=M.querySelector(".ls-rules"),Z={tpl:e.get("ruleTpl"),delete(e){if(x.deleteRule(e)){let t=N.querySelector(`[data-mark="${e}"]`),a=t.previousElementSibling.querySelector("input");a.focus(),a.selectionStart=a.selectionEnd=a.value.length,t.parentNode.removeChild(t)}},insert(e,t=Z.tpl){if(!e)return;let a=Z.tpl.innerHTML.replace(/\${(?:letter|rule)}/g,e);t.insertAdjacentHTML("beforebegin",a),x.setRule(e,e);let F=N.querySelector(`input[data-letter="${e}"]`);F.focus(),F.select()},replace(e,t){if(x.deleteRule(e)){x.setRule(t,t);let a=N.querySelector(`[data-mark="${e}"]`),F=N.querySelector(`input[data-letter="${e}"]`);a.dataset.mark=t,F.dataset.letter=t,F.focus()}},sync(){[...N.querySelectorAll("[data-mark]:not([data-mark='F']):not([data-mark='B'])")].forEach(e=>e.parentNode.removeChild(e));let e=Z.tpl.innerHTML;for(let[t,a]of x.rules)if("F"===t||"B"===t)N.querySelector(`input[data-letter="${t}"]`).value=a;else{let F=e.replace(/\${letter}/g,t).replace(/\${rule}/g,a);Z.tpl.insertAdjacentHTML("beforebegin",F)}}},$={clickAddRule(){Z.insert([...x.vacantLetters][0])},keyDownBackspace(e){let t=e.target,a=t.dataset.letter;a&&!t.value&&(Z.delete(a),e.preventDefault())},keyDownDelete(e){e.ctrlKey&&Z.delete(e.target.dataset.letter)},keyDownInsert(e){let t=e.target.dataset.letter;if(t){let e="F"===t?void 0:N.querySelector(`[data-mark="${t}"]`).nextElementSibling;Z.insert([...x.vacantLetters][0],e)}},clickRuleLetter({target:e}){let t=e.dataset.mark;if(t&&"F"!==t&&"B"!==t){if(!P.classList.contains("visible")){let e=x.vacantLetters;[...P.getElementsByTagName("button")].forEach(t=>{t.disabled=t.value&&!e.has(t.value)})}P.classList.toggle("visible"),P.classList.contains("visible")&&(P.style.left=`${e.offsetLeft}px`,P.style.top=`${e.offsetTop+e.offsetHeight}px`,P.dataset.ownerLetter=t)}},clickPopupBtn(e){let t=e.target.value,a=P.dataset.ownerLetter;t?Z.replace(a,t):Z.delete(a),P.classList.remove("visible")},clickPlot(t){t.preventDefault();let a=[...N.querySelectorAll("input[data-letter]")],F=new Map(a.map(e=>[e.dataset.letter,e.value.toUpperCase()]));try{x.reset(),x.axiom=e.get("axiom").value.toUpperCase(),x.alpha=-e.get("alpha").value*Math.PI/180,x.theta=e.get("theta").value*Math.PI/180,x.step=Number(e.get("step").value),x.iterCount=Number(e.get("iterCount").value),x.setRules(F)}catch(e){return void alert(e.message)}W.plot()},syncLSystem(){e.get("axiom").value=x.axiom,e.get("alpha").value=(180*-x.alpha/Math.PI).toFixed(3),e.get("theta").value=(180*x.theta/Math.PI).toFixed(3),e.get("step").value=x.step,e.get("iterCount").value=x.iterCount,Z.sync()}};t("addRule","click",$.clickAddRule),t(N,"keydown",e=>{let t=`keyDown${e.key}`;$.hasOwnProperty(t)&&$[t](e)}),t(N,"click",$.clickRuleLetter),t(P,"click",$.clickPopupBtn),t("plot","click",$.clickPlot),l("LSystemConfigured",$.syncLSystem);let I=e.get("appearance.panels"),U=e.get("mainArea"),D={setFg(e){W.settings.strokeStyle=e,W.repaint()},setBg(e){W.settings.fillStyle=document.body.style.background=e,W.repaint()},transforms:{rotate:{pattern:/\s*rotate\(.+?deg\)/,unit:"deg"},translateX:{pattern:/\s*translateX\(.+?px\)/,unit:"px"},translateY:{pattern:/\s*translateY\(.+?px\)/,unit:"px"},scale:{pattern:/\s*scale\(.+?\)/,unit:""}},setTransform(e,t){let{style:a}=U,{pattern:F,unit:l}=D.transforms[e],r=a.transform.replace(F,"").trim();a.transform=t?`${r} ${e}(${t}${l})`.trim():r}},O={changeFg(e){D.setFg(e.target.value)},changeBg(e){D.setBg(e.target.value)},toggleTransparency(t){let a=e.get("bgClr"),F=a.disabled=t.target.checked;D.setBg(F?"transparent":a.value)},changeTransform({target:e}){let{transform:t}=e.dataset;t&&e.validity.valid&&D.setTransform(t,e.value.trim())}};t("fgClr","change",O.changeFg),t("bgClr","change",O.changeBg),t("noBgClr","change",O.toggleTransparency),t(I,"change",O.changeTransform);let H=e.get("exporting.panels"),V=e.get("exportImg"),j=e.get("canvas"),q={makeImgLink(e="image/png"){URL.revokeObjectURL(V.href),j.toBlob(t=>{let a=e.slice(e.lastIndexOf("/")+1);V.href=URL.createObjectURL(t),V.download=`l-system.${a}`,V.innerHTML=`Download ${a.toUpperCase()}…`,H.classList.add("ls-export-requested")},e)},unmakeImgLink(){H.classList.remove("ls-export-requested")},getLSystemLink(){let e=`${location.origin}${location.pathname}?~ls~=`;e+=`ax${encodeURIComponent(x.axiom)}~`;for(let[t,a]of x.rules)e+=`r${t}${encodeURIComponent(a)}~`;return e+=`al${(180*-x.alpha/Math.PI).toFixed(3)}~`,e+=`th${(180*x.theta/Math.PI).toFixed(3)}~`,e+=`it${x.iterCount}~`,e+=`st${x.step}`},checkURLQuery(){let e=location.search;/[?&]~ls~=([^&]+)/.exec(e)?this.setupByParams(RegExp.$1):/[?&]ls=([^&]+)/.exec(e)&&this.setupByName(RegExp.$1)},setupByParams(e){x.reset();for(let t of e.split("~")){let e=t.slice(0,2),a=decodeURIComponent(t.slice(2));switch(e){case"ax":x.axiom=a;break;case"al":x.alpha=-a*Math.PI/180;break;case"th":x.theta=a*Math.PI/180;break;case"it":x.iterCount=+a;break;case"st":x.step=+a;break;default:"r"===e[0]&&x.setRule(a,e[1])}}F("LSystemConfigured"),W.plot()},setupByName(e){let[t,a]=decodeURIComponent(e).split("#");if(!r.hasOwnProperty(t)||!r[t].hasOwnProperty(a))return;let l=r[t][a];x.reset(),x.axiom=l.axiom,x.alpha=-l.alpha*Math.PI/180,x.theta=l.theta*Math.PI/180,x.step=l.step,x.iterCount=l.iterCount,x.setRules(new Map(Object.entries(l.rules))),F("LSystemConfigured"),W.plot()}},Q={clickExportControl(e){let t=e.target;t===V?q.unmakeImgLink():t.dataset.mimeType&&q.makeImgLink(t.dataset.mimeType)},clickMakeLink(){let t=e.get("linkAddress");t.value=q.getLSystemLink(),t.focus(),t.select(),e.get("link.clipboard").disabled=!1},focusLinkAddress(e){e.target.select()},clickCopy(){R(e.get("linkAddress").value)}};t(H.querySelector(".ls-export-controls"),"click",Q.clickExportControl),t("makeLink","click",Q.clickMakeLink),t("linkAddress","focus",Q.focusLinkAddress),t(e.get("link.clipboard"),"click",Q.clickCopy),q.checkURLQuery();let J=[...e.get(".panels").values()].find(e=>e.classList.contains("ls-panel-open"));function G(t,a=!1){let F=e.get(`${t}.panels`);F&&(F!==J?(J&&J.classList.remove("ls-panel-open"),F.classList.add("ls-panel-open"),J=F):a&&J&&(J.classList.remove("ls-panel-open"),J=null))}t("tabs","click",e=>{let t=e.target.dataset.lsRef;t&&G(t,!0)}),l("LSystemConfigured",()=>{G("settings")}),window.innerWidth>=980&&G("collections"),A||e.get(".clipboard").forEach(e=>{e.classList.add("hidden")});{let a=e.get("canvas"),F=null,l=()=>{F=null,a.width=a.offsetWidth,a.height=a.offsetHeight,W.repaint()};t(window,"resize",()=>{null!==F&&clearTimeout(F),F=setTimeout(l,100)}),l()}
