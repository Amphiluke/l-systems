let dom={ui:new Map,cache(e,t){let a=t.indexOf(".");if(a>=0){let l=t.slice(a),F=this.ui.get(l);F||(F=new Map,this.ui.set(l,F)),F.set(t.slice(0,a),e)}else this.ui.set(t,e)},getElementByLSID:(e,t=document.body)=>t.querySelector(`[data-ls-id="${e}"]`)};for(let e of document.body.querySelectorAll("[data-ls-id]"))dom.cache(e,e.dataset.lsId);let handlerRegistry=new Map,channel={publish(e,...t){let a=handlerRegistry.get(e);a&&a.forEach(e=>e(...t))},subscribe(e,t){let a=handlerRegistry.get(e);a||(a=[],handlerRegistry.set(e,a)),a.push(t)},unsubscribe(e,t){let a=handlerRegistry.get(e);if(a){let l=a.indexOf(t);l>=0&&(a.splice(l,1),a.length||handlerRegistry.delete(e))}}};var bankData={Plants:{"bush 1":{axiom:"F",rules:{F:"F[+FF][-FF]F[-F][+F]F"},alpha:90,theta:35,iterCount:4,step:6},"bush 2":{axiom:"F",rules:{F:"FF+[+F-F-F]-[-F+F+F]"},alpha:90,theta:22.5,iterCount:4,step:9},sticks:{axiom:"X",rules:{F:"FF",X:"F[+X]F[-X]+X"},alpha:90,theta:20,iterCount:7,step:2},"plant 1":{axiom:"X",rules:{F:"FF",X:"F-[[X]+X]+F[+FX]-X"},alpha:90,theta:25,iterCount:6,step:3},"plant 2":{axiom:"F",rules:{F:"F[+F]F[-F][F]"},alpha:90,theta:20,iterCount:5,step:8},"plant 3":{axiom:"X",rules:{F:"FF",X:"F[+X][-X]FX"},alpha:90,theta:25.71,iterCount:6,step:3.5},"savine 1":{axiom:"F-F[-F+F-F]+[+F-F-F]",rules:{F:"-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:3,step:3},"savine 2":{axiom:"-[F-F[-F+F-F]+[+F-F-F]]+[F-F[-F+F-F]+[+F-F-F]]",rules:{F:"-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]-F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:3,step:3},"liana sarment":{axiom:"FYX",rules:{F:"FFFXYFXY-[FFFXYFXY]",X:"Y[[XY]+X]+F[+FX]+XF",Y:"[FFF[[YX]+Y]+F[+FY]+F]"},alpha:90,theta:20,iterCount:4,step:.5},"liana tangle":{axiom:"FYX",rules:{F:"FFFXYFXY-[FFFXYFXY]",X:"Y[[XY]+X]+F[+FX]+XF",Y:"FFF[[YX]+Y]+F[+FY]+F"},alpha:90,theta:20,iterCount:4,step:2},tree:{axiom:"F",rules:{F:"-F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:5,step:15},weed:{axiom:"F",rules:{F:"F[+F]F[-F]F"},alpha:90,theta:25.714,iterCount:5,step:2},"flower 1":{axiom:"F[+F+F][-F-F][++F][--F]F",rules:{F:"FF[++F][+F][F][-F][--F]"},alpha:90,theta:11.25,iterCount:3,step:15},"bush 3":{axiom:"VZFFF",rules:{F:"F",V:"[+++W][---W]YV",W:"+X[-W]Z",X:"-W[+X]Z",Y:"YZ",Z:"[-FFF][+FFF]F"},alpha:90,theta:20,iterCount:9,step:10},algae:{axiom:"AF",rules:{A:"FFFFFV[+++H][---Q]BW",B:"B",C:"FFFFFV[+++BA]BD",D:"FFFFFV[+++H][---Q]BE",E:"FFFFFV[+++H][---Q]BG",F:"F",G:"FFFFFV[---BA]BA",H:"IBFF",I:"BFFF[--M]J",J:"BFFF[--N]K",K:"BFFF[--O]L",L:"BFFF[--P]",M:"BFN",N:"BFO",O:"BFP",P:"BF",Q:"RBF",R:"BFFF[++M]S",S:"BFFF[++N]T",T:"BFFF[++O]U",U:"BFFF[++P]",V:"FV",W:"FFFFFV[+++H][---Q]BC"},alpha:90,theta:12,iterCount:17,step:2},"algae 2":{axiom:"AF",rules:{A:"FFFFFY[++++N][----T]BZ",B:"B",C:"FFFFFY[++++N][----T]BD",D:"FFFFFY[++++N][----T]BE",E:"FFFFFY[++++N][----T]BG",F:"F",G:"FFFFFY[+++BA]BH",H:"FFFFFY[++++N][----T]BI",I:"+FFFFFY[++++N][----T]BJ",J:"FFFFFY[++++N][----T]BK",K:"-FFFFFY[++++N][----T]BL",L:"FFFFFY[++++N][----T]BM",M:"FFFFFY[---BA]BA",N:"OBFFF",O:"BFFFP",P:"BFFF[-S]Q",Q:"BFFF[-S]R",R:"BFFF[-S]",S:"BFBF",T:"UBFFF",U:"BFFFV",V:"BFFF[+S]W",W:"BFFF[+S]X",X:"BFFF[+S]",Y:"FY",Z:"+FFFFFY[++++N][----T]BC"},alpha:90,theta:12,iterCount:17,step:2},"plant 4":{axiom:"--------C",rules:{F:"F",C:"NF[--P]F+C",N:"NFF",P:"Q",Q:"C"},alpha:0,theta:11.25,iterCount:20,step:1.2},"plant 5":{axiom:"----G",rules:{F:"F",G:"GFX[+G][-G]",X:"X[-FFF][+FFF]FX"},alpha:0,theta:25.7,iterCount:6,step:4},dandelion:{axiom:"FF[-Y][Z][+Z]",rules:{F:"F",Y:"FF+F-F-F[FFFZ][+Z]-F-FZ",Z:"FF-F+F+F[Y][-Y]+F+FY"},alpha:90,theta:15,iterCount:6,step:6},sapling:{axiom:"FFFFFFX",rules:{F:"F",X:"FFF-[-F+F[Y]-[X]]+[+F+F[X]-[X]]",Y:"FF-[-F+F]+[+F+FY]"},alpha:90,theta:15,iterCount:6,step:10},"flower 2":{axiom:"F-F+F[++X][F+X][F-X][--X]",rules:{F:"F",W:"F-F+F[++X][F+X][F-X][--X]",X:"F+FF-F[++Y][+Y][-Z][--Z]",Y:"-[Z]F-FF-FF-FF-F[Z]",Z:"+[Y]F+FF+FF+FF+F[Y]"},alpha:90,theta:10,iterCount:9,step:4.5},"bonsai branch":{axiom:"A",rules:{F:"F",A:"F-FFA+[FAFA+FFF]F"},alpha:90,theta:30,iterCount:5,step:7}},Curves:{"Hilbert curve":{axiom:"X",rules:{F:"F",X:"-YF+XFX+FY-",Y:"+XF-YFY-FX+"},alpha:0,theta:90,iterCount:6,step:7},"Gosper curve":{axiom:"XF",rules:{F:"F",X:"X+YF++YF-FX--FXFX-YF+",Y:"-FX+YFYF++YF+FX--FX-Y"},alpha:0,theta:60,iterCount:4,step:8},"Peano curve":{axiom:"F",rules:{F:"F-F+F+F+F-F-F-F+F"},alpha:45,theta:90,iterCount:4,step:8},"Sierpinski curve":{axiom:"F+FX+F+XF",rules:{F:"F",X:"XF-F+F-XF+F+XF-F+F-X"},alpha:45,theta:90,iterCount:4,step:8},curve:{axiom:"F-F-F-F-",rules:{F:"FF-F-F-F-F-F+F"},alpha:0,theta:90,iterCount:4,step:3.5},cross:{axiom:"FX",rules:{X:"FX+FX+FXFY-FY-",Y:"+FX+FXFY-FY-FY"},alpha:0,theta:90,iterCount:5,step:4.5},island:{axiom:"F+F+F+F",rules:{F:"F+F-F-FFF+F+F-F"},alpha:0,theta:90,iterCount:3,step:4},"Koch’s snowflake":{axiom:"F++F++F",rules:{F:"F-F++F-F"},alpha:0,theta:60,iterCount:4,step:5},"Koch’s curve":{axiom:"F+F+F+F",rules:{F:"FF+F+F+F+F+F-F"},alpha:0,theta:90,iterCount:4,step:3.5},chain:{axiom:"F+F+F+F",rules:{F:"F+B-F-FFF+F+B-F",B:"BBB"},alpha:0,theta:90,iterCount:3,step:4},frame:{axiom:"YXY-YXY-YXY-YXY",rules:{X:"FX+FX+FXFYFX+FXFY-FY-FY-",Y:"+FX+FX+FXFY-FYFXFY-FY-FY"},alpha:0,theta:90,iterCount:3,step:4},"Moore’s curl":{axiom:"X",rules:{X:"FX+FX+FXFYFX+FXFY-FY-FY-",Y:"+FX+FX+FXFY-FYFXFY-FY-FY"},alpha:180,theta:90,iterCount:4,step:3.5},"anklets of Krishna":{axiom:"-X--X",rules:{F:"F",X:"XFX--XFX"},alpha:0,theta:45,iterCount:5,step:10},"mango-tree foliage":{axiom:"A---A",rules:{F:"F",B:"B",A:"B-F+Z+F-BA",Z:"F-FF-F--[--Z]F-FF-F--F-FF-F--"},alpha:0,theta:60,iterCount:7,step:15},pentive:{axiom:"Q",rules:{P:"--FR++++FS--FU",Q:"FT++FR----FS++",R:"++FP----FQ++FT",S:"FU--FP++++FQ--",T:"+FU--FP+",U:"-FQ++FT-"},alpha:36,theta:36,iterCount:7,step:15},"Sierpinski median curve":{axiom:"L--F--L--F",rules:{F:"F",L:"+R-F-R+",R:"-L+F+L-"},alpha:0,theta:45,iterCount:10,step:5},lace:{axiom:"W",rules:{F:"F",W:"+++X--F--ZFX+",X:"---W++F++YFW-",Y:"+ZFX--F--Z+++",Z:"-YFW++F++Y---"},alpha:180,theta:30,iterCount:7,step:4.5},"Peano-c":{axiom:"+Z",rules:{X:"FX-FY-FX+FY+FX+FY+FX+FY+FX-FY-FX-FY-FX-FY-FX+FY+FX",Y:"FY",Z:"FX"},alpha:0,theta:45,iterCount:5,step:3.5},"Hex-7-b":{axiom:"FX",rules:{X:"-F++F-X-F--F+Y---F--F+Y+F++F-X+++F++F-X-F++F-X+++F--F+Y--",Y:"+F++F-X-F--F+Y+F--F+Y---F--F+Y---F++F-X+++F++F-X+++F--F+Y"},alpha:0,theta:30,iterCount:4,step:5}},Shapes:{"Sierpinski carpet":{axiom:"FXF--FF--FF",rules:{F:"FF",X:"--FXF++FXF++FXF--",Y:"-FX-Y"},alpha:0,theta:60,iterCount:5,step:7},mosaic:{axiom:"F-F-F-F",rules:{F:"F-B+FF-F-FF-FB-FF+B-FF+F+FF+FB+FFF",B:"BBBBBB"},alpha:0,theta:90,iterCount:2,step:7},snowflake:{axiom:"[F]+[F]+[F]+[F]+[F]+[F]",rules:{F:"F[++F][-FF]FF[+F][-F]FF"},alpha:0,theta:60,iterCount:3,step:2},crystal:{axiom:"F+F+F+F",rules:{F:"FF+F++F+F"},alpha:0,theta:90,iterCount:4,step:5},pentigree:{axiom:"F-F-F-F-F",rules:{F:"F-F++F+F-F-F"},alpha:0,theta:72,iterCount:4,step:5},square:{axiom:"F+F+F+F",rules:{F:"FF+F+F+F+FF"},alpha:0,theta:90,iterCount:4,step:5},"fluffy globule":{axiom:"X-X-X-X-X-X-X-X-X",rules:{X:"FX+X--X+X--X+X--X+X"},alpha:0,theta:40,iterCount:4,step:18},horizons:{axiom:"+F++++F",rules:{F:"F+F+F++++F+F+F"},alpha:0,theta:45,iterCount:5,step:1.3},napkin:{axiom:"F--F--F--F--F--F",rules:{F:"-F[--F--F]++F--F+"},alpha:0,theta:30,iterCount:4,step:4.5},"Levi’s fractal":{axiom:"F",rules:{F:"+F--F+"},alpha:180,theta:45,iterCount:14,step:1.9},"Levi’s carpet":{axiom:"F++F++F++F",rules:{F:"+F--F+"},alpha:180,theta:45,iterCount:14,step:1.8},"spiral tiling":{axiom:"AAAA",rules:{F:"F",A:"X+X+X+X+X+X+",X:"[F+F+F+F[---X-Y]+++++F++++++++F-F-F-F]",Y:"[F+F+F+F[---Y]+++++F++++++++F-F-F-F]"},alpha:0,theta:15,iterCount:5,step:10},"Penrose mosaic":{axiom:"+WF--XF---YF--ZF",rules:{W:"YF++ZF----XF[-YF----WF]++",X:"+YF--ZF[---WF--XF]+",Y:"-WF++XF[+++YF++ZF]-",Z:"--YF++++WF[+ZF++++XF]--XF"},alpha:270,theta:36,iterCount:6,step:11},"Penrose tesselation":{axiom:"[X]++[X]++[X]++[X]++[X]",rules:{W:"YF++ZF----XF[-YF----WF]++",X:"+YF--ZF[---WF--XF]+",Y:"-WF++XF[+++YF++ZF]-",Z:"--YF++++WF[+ZF++++XF]--XF"},alpha:0,theta:36,iterCount:5,step:20},"snowflake 2":{axiom:"F[X]F++F[X]F++F[X]F++F[X]F",rules:{X:"[+Y][-Y][++Y][--Y]",Y:"YF[X]YF"},alpha:0,theta:45,iterCount:9,step:.9},wheel:{axiom:"F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]+F[X]",rules:{X:"[+++++++++++++Y[X]]-------------Y[X]",Y:"YFYF"},alpha:0,theta:5,iterCount:7,step:2},"hexagonal star":{axiom:"S",rules:{L:"LZFR--FR-F++LF++L-F+LF+R--Y",R:"Z++L-FR-F+R--FR--F+LF++LFYR",S:"L",Y:"+",Z:"-"},alpha:0,theta:60,iterCount:6,step:4.75},HexGasket:{axiom:"F+F+F+F+F+F--",rules:{F:"F+F+F--F--F+F+F"},alpha:0,theta:60,iterCount:4,step:3}},Dragons:{dragon:{axiom:"FX",rules:{F:"F",X:"X+YF+",Y:"-FX-Y"},alpha:0,theta:90,iterCount:12,step:5},terdragon:{axiom:"F",rules:{F:"F+F-F"},alpha:120,theta:120,iterCount:8,step:6},"median dragon":{axiom:"-X",rules:{F:"F",X:"X+F+Y",Y:"X-F-Y"},alpha:0,theta:45,iterCount:12,step:3}},Miscellaneous:{urchin:{axiom:"F",rules:{F:"F[-F+F-F]+[+F-F-F]"},alpha:0,theta:20,iterCount:5,step:15},"Cesaro 1":{axiom:"F",rules:{F:"F++++++++++F--------------------F++++++++++F"},alpha:180,theta:8,iterCount:6,step:2.9},"Cesaro 2":{axiom:"F+++++++++F------------------F+++++++++F------------------F+++++++++F------------------F+++++++++F------------------F",rules:{F:"F++++++++F----------------F++++++++F"},alpha:0,theta:10,iterCount:5,step:3.5}}};let ruleRE=/^[A-Z+\-[\]]*$/,validator={messages:{AXIOM:"The axiom may contain only the following characters: “A”-Z”, “+”, “-”, “[”, “]”",RULE:"Production rules may may contain only the following characters: “A”-Z”, “+”, “-”, “[”, “]”",LETTER:"The allowed alphabet letters are: “A”-“Z”",ALPHA:"The “alpha” parameter must be a finite number",THETA:"The “theta” parameter must be a finite number",STEP:"The “step” parameter must be a positive finite number",COUNT:"The number of iterations must be integer and finite",NUMBER:"A valid finite number expected"},checkRule:(e,t=validator.messages.RULE)=>ruleRE.test(e)||t,checkLetter:(e,t=validator.messages.LETTER)=>1===e.length&&e>="A"&&e<="Z"||t,checkStep:(e,t=validator.messages.STEP)=>Number.isFinite(e)&&e>0||t,checkCount:(e,t=validator.messages.COUNT)=>Number.isInteger(e)&&e>0||t,checkNumber:(e,t=validator.messages.NUMBER)=>Number.isFinite(e)||t};const ctrlRuleList=[["F",""],["B",""],["+","+"],["-","-"],["[","["],["]","]"]],defaults={alpha:0,theta:0,step:10,iterCount:3};let axiom,rules,settings,ls={get axiom(){return axiom},set axiom(e){let t=validator.checkRule(e,validator.messages.AXIOM);if(!0!==t)throw new Error(t);axiom=e},get alpha(){return settings.alpha},set alpha(e){let t=validator.checkNumber(e,validator.messages.ALPHA);if(!0!==t)throw new Error(t);settings.alpha=e},get theta(){return settings.theta},set theta(e){let t=validator.checkNumber(e,validator.messages.THETA);if(!0!==t)throw new Error(t);settings.theta=e},get step(){return settings.step},set step(e){let t=validator.checkStep(e);if(!0!==t)throw new Error(t);settings.step=e},get iterCount(){return settings.iterCount},set iterCount(e){let t=validator.checkCount(e);if(!0!==t)throw new Error(t);settings.iterCount=e},get rules(){let e=[...rules].filter(([e])=>e>="A"&&e<="Z");return new Map(e)},setRule(e,t){let a=validator.checkLetter(t);if(!0!==a)throw new Error(a);if(!0!==(a=validator.checkRule(e)))throw new Error(a);rules.set(t,e)},setRules(e){e.forEach(this.setRule,this)},deleteRule:e=>!("F"===e||"B"===e||!rules.has(e))&&(rules.delete(e),!0),get vacantLetters(){let e=new Set;for(let t of"ACDEGHIJKLMNOPQRSTUVWXYZ")rules.has(t)||e.add(t);return e},getCode(){let e=axiom;for(let t=settings.iterCount;t>0;t--){let t="";for(let a of e)t+=rules.get(a)||"";e=t}return e},reset(){axiom="",settings=Object.assign({},defaults),rules=new Map(ctrlRuleList)}};ls.reset();let canvas=dom.ui.get("canvas"),ctx=canvas.getContext("2d"),plotData={stack:[]},actions=new Map;actions.set("F",()=>{plotData.x+=plotData.step*Math.cos(plotData.alpha),plotData.y+=plotData.step*Math.sin(plotData.alpha),ctx.lineTo(plotData.x,plotData.y)}),actions.set("B",()=>{plotData.x+=plotData.step*Math.cos(plotData.alpha),plotData.y+=plotData.step*Math.sin(plotData.alpha),ctx.moveTo(plotData.x,plotData.y)}),actions.set("+",()=>{plotData.alpha+=plotData.theta}),actions.set("-",()=>{plotData.alpha-=plotData.theta}),actions.set("[",()=>{plotData.stack.push({x:plotData.x,y:plotData.y,alpha:plotData.alpha})}),actions.set("]",()=>{({x:plotData.x,y:plotData.y,alpha:plotData.alpha}=plotData.stack.pop()),ctx.moveTo(plotData.x,plotData.y)});let preactions=new Map([...actions]);preactions.set("F",()=>{plotData.x+=plotData.step*Math.cos(plotData.alpha),plotData.y+=plotData.step*Math.sin(plotData.alpha),plotData.left=Math.min(plotData.left,plotData.x),plotData.right=Math.max(plotData.right,plotData.x),plotData.top=Math.min(plotData.top,plotData.y),plotData.bottom=Math.max(plotData.bottom,plotData.y)}),preactions.set("B",preactions.get("F")),preactions.set("]",()=>{({x:plotData.x,y:plotData.y,alpha:plotData.alpha}=plotData.stack.pop())});let plotter={settings:{fillStyle:"transparent",strokeStyle:"#080"},reset(){plotData.cleanCode="",plotData.x=plotData.y=0,({step:plotData.step,alpha:plotData.alpha,theta:plotData.theta,iterCount:plotData.count}=ls),plotData.stack.length=0,plotData.left=plotData.top=Number.MAX_VALUE,plotData.right=plotData.bottom=-Number.MAX_VALUE},prepare(){let e=ls.getCode(),t="";for(let a of e){let e=preactions.get(a);e&&(t+=a,e())}plotData.cleanCode=t},setup(){plotData.x=(canvas.offsetWidth-plotData.left-plotData.right)/2,plotData.y=(canvas.offsetHeight-plotData.top-plotData.bottom)/2,plotData.alpha=ls.alpha,plotData.stack.length=0},clear(){ctx.strokeStyle=this.settings.strokeStyle,ctx.fillStyle=this.settings.fillStyle,ctx.clearRect(0,0,canvas.offsetWidth,canvas.offsetHeight),ctx.fillRect(0,0,canvas.offsetWidth,canvas.offsetHeight)},repaint(){if(this.clear(),plotData.cleanCode){this.setup(),ctx.beginPath(),ctx.moveTo(plotData.x,plotData.y);for(let e of plotData.cleanCode)actions.get(e)();ctx.stroke()}},plot(){this.reset(),this.prepare(),this.repaint()}};{let e=null,t=()=>{e=null,canvas.width=canvas.offsetWidth,canvas.height=canvas.offsetHeight,plotter.repaint()};window.addEventListener("resize",()=>{null!==e&&clearTimeout(e),e=setTimeout(t,100)}),t()}let bank=new Map,collectionCtrl={get current(){return dom.ui.get("collections").value},set current(e){dom.ui.get("collections").value=e,collectionCtrl.fillLSystemList(),collectionCtrl.updateControlStates()},fillBank(){dom.ui.get("collections").length=0;for(let e of Object.keys(bankData).sort())collectionCtrl.add(e,bankData[e],!1,!1);collectionCtrl.current=bank.keys().next().value;let e=localStorage.getItem("userCollections");if(e){e=JSON.parse(e);for(let t of Object.keys(e).sort())collectionCtrl.add(t,e[t],!0,!1)}},fillLSystemList(e=collectionCtrl.current){let t="";for(let a of bank.get(e).keys())t+=`<option>${a}</option>`;let a=dom.ui.get("lSystems");a.innerHTML=t,a.selectedIndex=0},setupLSystem(e,t=collectionCtrl.current){let a=bank.get(t).get(e);a&&(ls.reset(),ls.axiom=a.axiom,ls.alpha=-a.alpha*Math.PI/180,ls.theta=a.theta*Math.PI/180,ls.step=a.step,ls.iterCount=a.iterCount,ls.setRules(a.rules))},add(e,t={},a=!0,l=!0){e=collectionCtrl._getValidName(e,bank);let F=collectionCtrl.plainToCollection(t);F.userDefined=a,bank.set(e,F);let o=document.createElement("option");o.text=e,dom.ui.get("collections").children[a?1:0].appendChild(o),l&&(collectionCtrl.current=e)},delete(e=collectionCtrl.current){if(!collectionCtrl.isUserDefined(e))throw new Error("Built in collection cannot be deleted");bank.delete(e),e===collectionCtrl.current&&(collectionCtrl.current=bank.keys().next().value);let t=dom.ui.get("collections");t.children[1].removeChild([...t.options].find(t=>t.text===e))},isUserDefined:(e=collectionCtrl.current)=>!!bank.get(e).userDefined,deleteLSystem(e,t=collectionCtrl.current){if(!collectionCtrl.isUserDefined(t))throw new Error("Built in collections cannot be modified");bank.get(t).delete(e);let a=dom.ui.get("lSystems");a.removeChild([...a.options].find(t=>t.text===e))},addLSystem(e,t=collectionCtrl.current){if(!collectionCtrl.isUserDefined(t))throw new Error("Built in collections cannot be modified");t=bank.get(t),e=collectionCtrl._getValidName(e,t);let a=new Map;a.axiom=ls.axiom,a.alpha=180*-ls.alpha/Math.PI,a.theta=180*ls.theta/Math.PI,a.step=ls.step,a.iterCount=ls.iterCount,a.rules=ls.rules,t.set(e,a);let l=document.createElement("option");l.text=e,dom.ui.get("lSystems").add(l)},updateControlStates(){dom.ui.get("deleteColl").disabled=dom.ui.get("addLS").disabled=dom.ui.get("removeLS").disabled=!collectionCtrl.isUserDefined()},storeUserCollections(){let e={};for(let t of bank.keys())collectionCtrl.isUserDefined(t)&&(e[t]=collectionCtrl.collectionToPlain(t));localStorage.setItem("userCollections",JSON.stringify(e))},collectionToPlain(e=collectionCtrl.current){let t={};for(let[a,l]of bank.get(e)){let e=t[a]={rules:{}};({axiom:e.axiom,alpha:e.alpha,theta:e.theta,iterCount:e.iterCount,step:e.step}=l);for(let[t,a]of l.rules)e.rules[t]=a}return t},plainToCollection(e){let t=new Map;for(let a of Object.keys(e).sort()){let l=e[a];l.rules=new Map(Object.keys(l.rules).map(e=>[e,l.rules[e]])),t.set(a,l)}return t},_getValidName(e,t){let a=2,l=e;for(;t.has(l);)l=`${e} (${a++})`;return l}};collectionCtrl.fillBank();let handlers={changeCollection(e){collectionCtrl.current=e.target.value},dblClickLSystem(e){collectionCtrl.setupLSystem(e.target.value),channel.publish("LSystemConfigured")},keyDownLSystem(e){switch(e.key){case"Enter":collectionCtrl.setupLSystem(e.target.value),channel.publish("LSystemConfigured");break;case" ":collectionCtrl.setupLSystem(e.target.value),plotter.plot();break;case"Delete":collectionCtrl.isUserDefined()&&window.confirm("Delete the selected L-system?")&&collectionCtrl.deleteLSystem(e.target.value)}},clickCreateCollection(){let e=window.prompt("Enter a new collection name",`collection #${bank.size+1}`);null!==e&&collectionCtrl.add(e)},clickDeleteCollection(){window.confirm("Delete the selected collection?")&&collectionCtrl.delete()},clickAddLS(){let e=window.prompt("Enter the name of the L-system","");null!==e&&collectionCtrl.addLSystem(e)},clickRemoveLS(){let e=dom.ui.get("lSystems");e.selectedIndex>=0&&collectionCtrl.isUserDefined()&&window.confirm("Delete the selected L-system?")&&collectionCtrl.deleteLSystem(e.value)},changeImport(e){let t=new FileReader,a=e.target.files[0];t.addEventListener("load",()=>{let e=a.name.endsWith(".json")?a.name.slice(0,-5):a.name;collectionCtrl.add(e,JSON.parse(t.result))}),t.addEventListener("error",()=>{throw t.error}),t.readAsText(a)},mouseDownExport(e){let t=e.target;URL.revokeObjectURL(t.href);let a=[JSON.stringify(collectionCtrl.collectionToPlain(),null,2)],l=new Blob(a,{type:"application/json"});t.href=URL.createObjectURL(l),t.download=`${collectionCtrl.current}.json`},beforeUnload(){collectionCtrl.storeUserCollections()}};dom.ui.get("collections").addEventListener("change",handlers.changeCollection),dom.ui.get("lSystems").addEventListener("dblclick",handlers.dblClickLSystem),dom.ui.get("lSystems").addEventListener("keydown",handlers.keyDownLSystem),dom.ui.get("createColl").addEventListener("click",handlers.clickCreateCollection),dom.ui.get("deleteColl").addEventListener("click",handlers.clickDeleteCollection),dom.ui.get("addLS").addEventListener("click",handlers.clickAddLS),dom.ui.get("removeLS").addEventListener("click",handlers.clickRemoveLS),dom.ui.get("importColl").addEventListener("change",handlers.changeImport),dom.ui.get("exportColl").addEventListener("mousedown",handlers.mouseDownExport),window.addEventListener("beforeunload",handlers.beforeUnload);let panel=dom.ui.get(".panels").get("settings"),popup=dom.ui.get("letterPopup"),rulesBlock=panel.querySelector(".ls-rules"),ruleCtrl={tpl:dom.ui.get("ruleTpl"),delete(e){if(ls.deleteRule(e)){let t=rulesBlock.querySelector(`[data-mark="${e}"]`),a=t.previousElementSibling.querySelector("input");a.focus(),a.selectionStart=a.selectionEnd=a.value.length,t.parentNode.removeChild(t)}},insert(e,t=ruleCtrl.tpl){if(!e)return;let a=ruleCtrl.tpl.innerHTML.replace(/\${(?:letter|rule)}/g,e);t.insertAdjacentHTML("beforebegin",a),ls.setRule(e,e);let l=rulesBlock.querySelector(`input[data-letter="${e}"]`);l.focus(),l.select()},replace(e,t){if(ls.deleteRule(e)){ls.setRule(t,t);let a=rulesBlock.querySelector(`[data-mark="${e}"]`),l=rulesBlock.querySelector(`input[data-letter="${e}"]`);a.dataset.mark=t,l.dataset.letter=t,l.focus()}},sync(){[...rulesBlock.querySelectorAll("[data-mark]:not([data-mark='F']):not([data-mark='B'])")].forEach(e=>e.parentNode.removeChild(e));let e=ruleCtrl.tpl.innerHTML;for(let[t,a]of ls.rules)if("F"===t||"B"===t)rulesBlock.querySelector(`input[data-letter="${t}"]`).value=a;else{let l=e.replace(/\${letter}/g,t).replace(/\${rule}/g,a);ruleCtrl.tpl.insertAdjacentHTML("beforebegin",l)}}},handlers$1={clickAddRule(){ruleCtrl.insert([...ls.vacantLetters][0])},keyDownBackspace(e){let t=e.target,a=t.dataset.letter;a&&!t.value&&(ruleCtrl.delete(a),e.preventDefault())},keyDownDelete(e){e.ctrlKey&&ruleCtrl.delete(e.target.dataset.letter)},keyDownInsert(e){let t=e.target.dataset.letter;if(t){let e="F"===t?void 0:rulesBlock.querySelector(`[data-mark="${t}"]`).nextElementSibling;ruleCtrl.insert([...ls.vacantLetters][0],e)}},clickRuleLetter(e){let t=e.target,a=t.dataset.mark;if(a&&"F"!==a&&"B"!==a){if(!popup.classList.contains("visible")){let e=ls.vacantLetters;[...popup.getElementsByTagName("button")].forEach(t=>{t.disabled=t.value&&!e.has(t.value)})}popup.classList.toggle("visible"),popup.classList.contains("visible")&&(popup.style.left=`${t.offsetLeft}px`,popup.style.top=`${t.offsetTop+t.offsetHeight}px`,popup.dataset.ownerLetter=a)}},clickPopupBtn(e){let t=e.target.value,a=popup.dataset.ownerLetter;t?ruleCtrl.replace(a,t):ruleCtrl.delete(a),popup.classList.remove("visible")},clickPlot(e){e.preventDefault();let t=[...rulesBlock.querySelectorAll("input[data-letter]")],a=new Map(t.map(e=>[e.dataset.letter,e.value.toUpperCase()]));try{ls.reset(),ls.axiom=dom.ui.get("axiom").value.toUpperCase(),ls.alpha=-dom.ui.get("alpha").value*Math.PI/180,ls.theta=dom.ui.get("theta").value*Math.PI/180,ls.step=Number(dom.ui.get("step").value),ls.iterCount=Number(dom.ui.get("iterCount").value),ls.setRules(a)}catch(e){return void alert(e.message)}plotter.plot()},syncLSystem(){dom.ui.get("axiom").value=ls.axiom,dom.ui.get("alpha").value=(180*-ls.alpha/Math.PI).toFixed(3),dom.ui.get("theta").value=(180*ls.theta/Math.PI).toFixed(3),dom.ui.get("step").value=ls.step,dom.ui.get("iterCount").value=ls.iterCount,ruleCtrl.sync()}};dom.ui.get("addRule").addEventListener("click",handlers$1.clickAddRule),rulesBlock.addEventListener("keydown",e=>{let t=`keyDown${e.key}`;handlers$1.hasOwnProperty(t)&&handlers$1[t](e)}),rulesBlock.addEventListener("click",handlers$1.clickRuleLetter),popup.addEventListener("click",handlers$1.clickPopupBtn),dom.ui.get("plot").addEventListener("click",handlers$1.clickPlot),channel.subscribe("LSystemConfigured",handlers$1.syncLSystem);let panel$1=dom.ui.get(".panels").get("appearance"),canvas$1=dom.ui.get("canvas"),appearanceCtrl={setFg(e){plotter.settings.strokeStyle=e,plotter.repaint()},setBg(e){plotter.settings.fillStyle=document.body.style.background=e,plotter.repaint()},transforms:{rotate:{pattern:/\s*rotate\(.+?deg\)/,unit:"deg"},translateX:{pattern:/\s*translateX\(.+?px\)/,unit:"px"},translateY:{pattern:/\s*translateY\(.+?px\)/,unit:"px"},scale:{pattern:/\s*scale\(.+?\)/,unit:""}},setTransform(e,t){let a=canvas$1.style,{pattern:l,unit:F}=appearanceCtrl.transforms[e],o=a.transform.replace(l,"").trim();a.transform=t?`${o} ${e}(${t}${F})`.trim():o}},handlers$2={changeFg(e){appearanceCtrl.setFg(e.target.value)},changeBg(e){appearanceCtrl.setBg(e.target.value)},toggleTransparency(e){let t=dom.ui.get("bgClr"),a=t.disabled=e.target.checked;appearanceCtrl.setBg(a?"transparent":t.value)},changeTransform(e){let t=e.target.dataset.transform;t&&e.target.validity.valid&&appearanceCtrl.setTransform(t,e.target.value.trim())}};dom.ui.get("fgClr").addEventListener("change",handlers$2.changeFg),dom.ui.get("bgClr").addEventListener("change",handlers$2.changeBg),dom.ui.get("noBgClr").addEventListener("change",handlers$2.toggleTransparency),panel$1.addEventListener("change",handlers$2.changeTransform);let panel$2=dom.ui.get(".panels").get("exporting"),exportLink=dom.ui.get("exportImg"),canvas$2=dom.ui.get("canvas"),exportCtrl={makeImgLink(e="image/png"){URL.revokeObjectURL(exportLink.href),canvas$2.toBlob(t=>{let a=e.slice(e.lastIndexOf("/")+1);exportLink.href=URL.createObjectURL(t),exportLink.download=`l-system.${a}`,exportLink.innerHTML=`Download ${a.toUpperCase()}…`,panel$2.classList.add("ls-export-requested")},e)},unmakeImgLink(){panel$2.classList.remove("ls-export-requested")},getLSystemLink(){let e=`${location.origin}${location.pathname}?~ls~=`;e+=`ax${encodeURIComponent(ls.axiom)}~`;for(let[t,a]of ls.rules)e+=`r${t}${encodeURIComponent(a)}~`;return e+=`al${(180*-ls.alpha/Math.PI).toFixed(3)}~`,e+=`th${(180*ls.theta/Math.PI).toFixed(3)}~`,e+=`it${ls.iterCount}~`,e+=`st${ls.step}`},checkURLQuery(){let e=location.search.match(/(?:\?|&)~ls~=([^&]+)/);if(e){ls.reset();for(let t of e[1].split("~")){let e=t.slice(0,2),a=decodeURIComponent(t.slice(2));switch(e){case"ax":ls.axiom=a;break;case"al":ls.alpha=-a*Math.PI/180;break;case"th":ls.theta=a*Math.PI/180;break;case"it":ls.iterCount=+a;break;case"st":ls.step=+a;break;default:"r"===e[0]&&ls.setRule(a,e[1])}}channel.publish("LSystemConfigured"),plotter.plot()}}},handlers$3={clickExportControl(e){let t=e.target;t===exportLink?exportCtrl.unmakeImgLink():t.dataset.mimeType&&exportCtrl.makeImgLink(t.dataset.mimeType)},clickMakeLink(){let e=dom.ui.get("linkAddress");e.value=exportCtrl.getLSystemLink(),e.focus(),e.select()},focusLinkAddress(e){e.target.select()}};panel$2.querySelector(".ls-export-controls").addEventListener("click",handlers$3.clickExportControl),dom.ui.get("makeLink").addEventListener("click",handlers$3.clickMakeLink),dom.ui.get("linkAddress").addEventListener("focus",handlers$3.focusLinkAddress),exportCtrl.checkURLQuery();let openedPanel=[...dom.ui.get(".panels").values()].find(e=>e.classList.contains("ls-panel-open")),panels={show(e,t=!1){let a=dom.ui.get(".panels").get(e);a&&(a!==openedPanel?(openedPanel&&openedPanel.classList.remove("ls-panel-open"),a.classList.add("ls-panel-open"),openedPanel=a):t&&this.hide())},hide(){openedPanel&&(openedPanel.classList.remove("ls-panel-open"),openedPanel=null)}};dom.ui.get("tabs").addEventListener("click",e=>{let t=e.target.dataset.lsRef;t&&panels.show(t,!0)}),channel.subscribe("LSystemConfigured",()=>{panels.show("settings")}),window.innerWidth>=980&&panels.show("collections");
